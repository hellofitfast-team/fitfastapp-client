---
phase: 05-hardening-api-routes
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/api/notifications/subscription/route.ts
  - src/app/api/notifications/reminder-time/route.ts
  - src/app/[locale]/(dashboard)/check-in/page.tsx
  - src/messages/en.json
  - src/messages/ar.json
autonomous: true

must_haves:
  truths:
    - "Subscription POST validates onesignal_subscription_id and device_type with Zod"
    - "Subscription DELETE validates onesignal_subscription_id with Zod"
    - "Reminder time PUT validates HH:MM format with Zod"
    - "Plan generation failures display clear warning to user (RELY-05)"
    - "Check-in page logs plan generation errors to Sentry"
    - "All console.error calls in these routes replaced with Sentry"
  artifacts:
    - path: "src/app/api/notifications/subscription/route.ts"
      provides: "Subscription management with Zod validation and Sentry"
      contains: "validateRequestBody"
    - path: "src/app/api/notifications/reminder-time/route.ts"
      provides: "Reminder time with Zod validation and Sentry"
      contains: "ReminderTimeSchema"
    - path: "src/app/[locale]/(dashboard)/check-in/page.tsx"
      provides: "Check-in submission with plan generation failure feedback"
      contains: "planGenerationWarning"
  key_links:
    - from: "src/app/[locale]/(dashboard)/check-in/page.tsx"
      to: "/api/plans/meal"
      via: "fetch with error handling and user warning"
      pattern: "planGenerationWarning"
    - from: "src/app/api/notifications/subscription/route.ts"
      to: "src/lib/api-validation/notifications.ts"
      via: "import SubscriptionSchema, UnsubscribeSchema"
      pattern: "import.*SubscriptionSchema.*from.*api-validation"
---

<objective>
Apply Zod validation to notification routes AND implement RELY-05 (plan generation failure feedback) on the check-in page.

Purpose: Notification routes need input validation and Sentry logging. The check-in page currently silently catches plan generation failures -- users must see a clear warning when their plans fail to generate (RELY-05). This plan also adds the required i18n keys for the warning message.
Output: 2 hardened notification routes + check-in page with plan generation failure feedback
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-hardening-api-routes/05-RESEARCH.md
@.planning/phases/05-hardening-api-routes/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden notification routes with Zod validation and Sentry</name>
  <files>
    src/app/api/notifications/subscription/route.ts
    src/app/api/notifications/reminder-time/route.ts
  </files>
  <action>
**For src/app/api/notifications/subscription/route.ts:**
- Import `{ validateRequestBody }` and `{ SubscriptionSchema, UnsubscribeSchema }` from `@/lib/api-validation`
- Import `* as Sentry` from `@sentry/nextjs`

In POST handler:
- Replace bare destructuring `const { onesignal_subscription_id, device_type } = await request.json()` and the manual `if (!onesignal_subscription_id)` check with:
  ```typescript
  const body = await request.json();
  const validation = validateRequestBody(body, SubscriptionSchema, {
    userId: user.id,
    feature: "push-subscription",
  });
  if (!validation.success) return validation.response;
  const { onesignal_subscription_id, device_type } = validation.data;
  ```
- Replace `console.error("Error saving subscription:", error)` with `Sentry.captureException(error, { tags: { feature: "push-subscription" }, extra: { userId: user.id, action: "save-subscription" } })`

In DELETE handler:
- Replace bare destructuring and manual check with:
  ```typescript
  const body = await request.json();
  const validation = validateRequestBody(body, UnsubscribeSchema, {
    userId: user.id,
    feature: "push-unsubscribe",
  });
  if (!validation.success) return validation.response;
  const { onesignal_subscription_id } = validation.data;
  ```

**For src/app/api/notifications/reminder-time/route.ts:**
- Import `{ validateRequestBody }` and `{ ReminderTimeSchema }` from `@/lib/api-validation`
- Import `* as Sentry` from `@sentry/nextjs`

In GET handler:
- No body validation needed (GET endpoint)
- The existing error handling is fine (returns 404 on profile not found)

In PUT handler:
- Replace bare destructuring `const { reminder_time } = await request.json()` and the manual regex check with:
  ```typescript
  const body = await request.json();
  const validation = validateRequestBody(body, ReminderTimeSchema, {
    userId: user.id,
    feature: "reminder-time",
  });
  if (!validation.success) return validation.response;
  const { reminder_time } = validation.data;
  ```
- Replace `console.error("Error updating reminder time:", error)` with `Sentry.captureException(error, { tags: { feature: "reminder-time" }, extra: { userId: user.id, action: "update-reminder" } })`
  </action>
  <verify>
`pnpm tsc --noEmit 2>&1 | grep -c "error TS"` returns 0 new errors.
`grep -c "console.error" src/app/api/notifications/subscription/route.ts src/app/api/notifications/reminder-time/route.ts` returns 0.
`grep -c "validateRequestBody" src/app/api/notifications/subscription/route.ts src/app/api/notifications/reminder-time/route.ts` returns at least 3 (2 in subscription, 1 in reminder-time).
  </verify>
  <done>All 3 notification route handlers (POST subscription, DELETE subscription, PUT reminder-time) validate input with Zod. All console.error replaced with Sentry.</done>
</task>

<task type="auto">
  <name>Task 2: Add plan generation failure feedback to check-in page (RELY-05)</name>
  <files>
    src/app/[locale]/(dashboard)/check-in/page.tsx
    src/messages/en.json
    src/messages/ar.json
  </files>
  <action>
This implements RELY-05: "User sees clear warning message when plan generation fails (not silent failure)".

**In src/messages/en.json**, add to the "checkIn" section:
```json
"planGenerationWarning": "Check-in saved! Plan generation is taking longer than expected. You'll see your new plans shortly.",
"planGenerationFailed": "Check-in saved, but we couldn't generate your plans right now. Your coach has been notified."
```

**In src/messages/ar.json**, add the Arabic translations to the "checkIn" section:
```json
"planGenerationWarning": "تم حفظ التسجيل! جاري إعداد الخطة الخاصة بك. ستراها قريباً.",
"planGenerationFailed": "تم حفظ التسجيل، لكن لم نتمكن من إنشاء خططك الآن. تم إبلاغ مدربك."
```

**In src/app/[locale]/(dashboard)/check-in/page.tsx:**
- Import `* as Sentry` from `@sentry/nextjs`
- Replace the current silent plan generation block (lines ~237-244):
  ```typescript
  // CURRENT (silent failure):
  try {
    await Promise.all([
      fetch("/api/plans/meal", ...),
      fetch("/api/plans/workout", ...),
    ]);
  } catch (planError) {
    console.error("Plan generation error:", planError);
  }
  toast({ title: t("checkInSuccess"), description: t("newPlanGenerated") });
  ```

  With proper error handling:
  ```typescript
  // NEW (RELY-05: user sees warning on failure):
  const [mealResponse, workoutResponse] = await Promise.all([
    fetch("/api/plans/meal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ checkInId: (checkInData as any).id }),
    }).catch((err) => {
      Sentry.captureException(err, {
        tags: { feature: "plan-generation", planType: "meal" },
        extra: { userId: user.id, checkInId: (checkInData as any).id },
      });
      return { ok: false } as Response;
    }),
    fetch("/api/plans/workout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ checkInId: (checkInData as any).id }),
    }).catch((err) => {
      Sentry.captureException(err, {
        tags: { feature: "plan-generation", planType: "workout" },
        extra: { userId: user.id, checkInId: (checkInData as any).id },
      });
      return { ok: false } as Response;
    }),
  ]);

  if (!mealResponse.ok || !workoutResponse.ok) {
    // RELY-05: Show clear warning to user that plans failed
    toast({
      title: t("checkInSuccess"),
      description: t("planGenerationWarning"),
    });
  } else {
    toast({
      title: t("checkInSuccess"),
      description: t("newPlanGenerated"),
    });
  }
  ```

- Also replace the `console.error("Error checking lock status:", error)` in the useEffect (around line 135) with:
  ```typescript
  Sentry.captureException(error, {
    tags: { feature: "check-in-lock-status" },
    extra: { userId: user.id },
  });
  ```

- Replace the `console.error("Check-in submission error:", error)` in the catch block (around line 250) with:
  ```typescript
  Sentry.captureException(error, {
    tags: { feature: "check-in-submission" },
    extra: { userId: user.id },
  });
  ```
  </action>
  <verify>
`pnpm tsc --noEmit 2>&1 | grep -c "error TS"` returns 0 new errors.
`grep -c "console.error" src/app/[locale]/(dashboard)/check-in/page.tsx` returns 0.
`grep -c "planGenerationWarning" src/app/[locale]/(dashboard)/check-in/page.tsx` returns at least 1.
`grep -c "planGenerationWarning" src/messages/en.json src/messages/ar.json` returns 2 (one per locale).
  </verify>
  <done>Plan generation failures show clear warning toast to user (not silent). Both English and Arabic warning messages added. All console.error replaced with Sentry in check-in page.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes (no new errors)
- Zero `console.error` in all modified files
- RELY-05: planGenerationWarning key exists in both en.json and ar.json
- RELY-05: Check-in page shows warning toast when plan generation fails
- All notification route handlers use Zod validation
</verification>

<success_criteria>
- RELY-05 satisfied: Plan generation failures display clear warning to user
- All notification routes validate input with Zod
- All console.error replaced with Sentry across all modified files
- i18n keys added for both English and Arabic
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-hardening-api-routes/05-04-SUMMARY.md`
</output>
