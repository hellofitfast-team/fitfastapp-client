---
phase: 05-hardening-api-routes
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/api/plans/meal/route.ts
  - src/app/api/plans/workout/route.ts
  - src/app/api/tickets/route.ts
  - src/app/api/auth/sign-in/route.ts
  - src/app/api/auth/profile/route.ts
  - src/app/api/auth/logout/route.ts
autonomous: true

must_haves:
  truths:
    - "Meal plan route validates request body with Zod before processing"
    - "Workout plan route validates request body with Zod before processing"
    - "Ticket creation validates subject, category, description with Zod"
    - "Sign-in route validates email with Zod before sending magic link"
    - "All console.error calls in these routes replaced with Sentry.captureException"
  artifacts:
    - path: "src/app/api/plans/meal/route.ts"
      provides: "Validated meal plan generation endpoint"
      contains: "validateRequestBody"
    - path: "src/app/api/plans/workout/route.ts"
      provides: "Validated workout plan generation endpoint"
      contains: "validateRequestBody"
    - path: "src/app/api/tickets/route.ts"
      provides: "Validated ticket CRUD with Sentry logging"
      contains: "validateRequestBody"
    - path: "src/app/api/auth/sign-in/route.ts"
      provides: "Validated sign-in with Sentry logging"
      contains: "validateRequestBody"
  key_links:
    - from: "src/app/api/plans/meal/route.ts"
      to: "src/lib/api-validation/plans.ts"
      via: "import GeneratePlanSchema"
      pattern: "import.*GeneratePlanSchema.*from.*api-validation"
    - from: "src/app/api/tickets/route.ts"
      to: "src/lib/api-validation/tickets.ts"
      via: "import CreateTicketSchema"
      pattern: "import.*CreateTicketSchema.*from.*api-validation"
---

<objective>
Apply Zod validation and Sentry error logging to plan generation routes, ticket routes, and auth routes.

Purpose: These 6 routes handle core user flows (plan generation, support tickets, authentication). Validating inputs prevents malformed data from reaching the service layer. Replacing console.error with Sentry provides visibility into production errors.
Output: 6 hardened API routes with input validation and structured error logging
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-hardening-api-routes/05-RESEARCH.md
@.planning/phases/05-hardening-api-routes/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden plan generation and ticket routes with Zod validation</name>
  <files>
    src/app/api/plans/meal/route.ts
    src/app/api/plans/workout/route.ts
    src/app/api/tickets/route.ts
  </files>
  <action>
**For src/app/api/plans/meal/route.ts:**
- Import `{ validateRequestBody }` and `{ GeneratePlanSchema }` from `@/lib/api-validation`
- After `const body = await request.json()`, replace the bare destructuring `const { checkInId, planDuration = 14 } = body` with:
  ```typescript
  const validation = validateRequestBody(body, GeneratePlanSchema, {
    userId: user.id,
    feature: "meal-plan-generation",
  });
  if (!validation.success) return validation.response;
  const { checkInId, planDuration } = validation.data;
  ```
- No other changes needed (already has Sentry in catch block from Phase 4)

**For src/app/api/plans/workout/route.ts:**
- Same pattern as meal route. Import and apply GeneratePlanSchema.
- Replace bare destructuring with validateRequestBody call using feature: "workout-plan-generation"

**For src/app/api/tickets/route.ts:**
- Import `{ validateRequestBody }` and `{ CreateTicketSchema }` from `@/lib/api-validation`
- Import `* as Sentry` from `@sentry/nextjs`
- In POST handler: replace the manual `if (!subject || !category)` check with:
  ```typescript
  const validation = validateRequestBody(body, CreateTicketSchema, {
    userId: user.id,
    feature: "ticket-creation",
  });
  if (!validation.success) return validation.response;
  const { subject, category, description, screenshot_url } = validation.data;
  ```
- Replace ALL `console.error(...)` calls (4 occurrences in GET and POST) with `Sentry.captureException(error, { tags: { feature: "tickets" }, extra: { userId: user.id, action: "fetch-tickets" | "create-ticket" } })`
- Keep the error response messages as-is (they are already descriptive)
  </action>
  <verify>
`pnpm tsc --noEmit 2>&1 | grep -c "error TS"` returns 0 new errors.
`grep -c "console.error" src/app/api/tickets/route.ts` returns 0.
`grep -c "validateRequestBody" src/app/api/plans/meal/route.ts src/app/api/plans/workout/route.ts src/app/api/tickets/route.ts` returns 3.
  </verify>
  <done>Plan routes validate checkInId/planDuration with Zod, tickets route validates subject/category/description with Zod, all console.error replaced with Sentry in tickets route</done>
</task>

<task type="auto">
  <name>Task 2: Harden auth routes with Zod validation and Sentry</name>
  <files>
    src/app/api/auth/sign-in/route.ts
    src/app/api/auth/profile/route.ts
    src/app/api/auth/logout/route.ts
  </files>
  <action>
**For src/app/api/auth/sign-in/route.ts:**
- Import `{ validateRequestBody }` and `{ SignInSchema }` from `@/lib/api-validation`
- Import `* as Sentry` from `@sentry/nextjs`
- Replace the bare destructuring `const { email, locale = "en" } = await request.json()` with:
  ```typescript
  const body = await request.json();
  const validation = validateRequestBody(body, SignInSchema, {
    feature: "sign-in",
  });
  if (!validation.success) return validation.response;
  const { email, locale } = validation.data;
  ```
- Replace both `console.error("Sign-in error:", ...)` and `console.error("Sign-in API error:", ...)` with `Sentry.captureException(error, { tags: { feature: "sign-in" }, extra: { email } })`
- For the Supabase auth error (line 27), use `Sentry.captureException(error, { level: "warning", tags: { feature: "sign-in" }, extra: { email } })` since bad emails are expected

**For src/app/api/auth/profile/route.ts:**
- Import `* as Sentry` from `@sentry/nextjs`
- Replace `console.error("Profile API error:", error)` with `Sentry.captureException(error, { tags: { feature: "profile" }, extra: { userId: user?.id } })`
- No body validation needed (GET endpoint, no request body)

**For src/app/api/auth/logout/route.ts:**
- Import `* as Sentry` from `@sentry/nextjs`
- Replace `console.error("Logout error:", error)` with `Sentry.captureException(error, { tags: { feature: "logout" } })`
- No body validation needed (POST with no body)
  </action>
  <verify>
`pnpm tsc --noEmit 2>&1 | grep -c "error TS"` returns 0 new errors.
`grep -rn "console.error" src/app/api/auth/` returns 0 results.
`grep -c "Sentry" src/app/api/auth/sign-in/route.ts src/app/api/auth/profile/route.ts src/app/api/auth/logout/route.ts` shows Sentry usage in all 3 files.
  </verify>
  <done>Sign-in validates email/locale with Zod, all 3 auth routes use Sentry instead of console.error</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes (no new errors)
- Zero `console.error` in all 6 modified route files
- `validateRequestBody` used in meal, workout, tickets, and sign-in routes
- Sentry.captureException used in all catch blocks
</verification>

<success_criteria>
- All 4 POST routes validate input with Zod before processing
- All console.error calls replaced with Sentry.captureException in these 6 files
- Existing functionality unchanged (same response shapes, same status codes)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-hardening-api-routes/05-02-SUMMARY.md`
</output>
