---
phase: 07-performance-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/pagination.tsx
  - src/app/[locale]/(admin)/admin/(panel)/clients/page.tsx
  - src/app/[locale]/(admin)/admin/(panel)/clients/clients-list.tsx
  - src/app/[locale]/(admin)/admin/(panel)/clients/pagination-controls.tsx
  - src/messages/en.json
  - src/messages/ar.json
autonomous: true

must_haves:
  truths:
    - "Admin clients list loads only one page of clients at a time (not all profiles)"
    - "Coach can navigate between pages of clients using Previous/Next and page number links"
    - "Coach can change page size (10, 25, 50, 100 per page)"
    - "Changing page size resets to page 1"
    - "Total client count is displayed in the page header"
    - "Client-side search still works within the current page of results"
    - "Pagination state persists in URL (back button works)"
  artifacts:
    - path: "src/components/ui/pagination.tsx"
      provides: "shadcn/ui Pagination component primitives"
    - path: "src/app/[locale]/(admin)/admin/(panel)/clients/pagination-controls.tsx"
      provides: "Client component with page navigation and page size selector"
      min_lines: 40
    - path: "src/app/[locale]/(admin)/admin/(panel)/clients/page.tsx"
      provides: "Server component with searchParams-based pagination using .range()"
      contains: ".range("
    - path: "src/app/[locale]/(admin)/admin/(panel)/clients/clients-list.tsx"
      provides: "Client list with search filtering"
  key_links:
    - from: "src/app/[locale]/(admin)/admin/(panel)/clients/page.tsx"
      to: "supabase .range(from, to)"
      via: "searchParams page/pageSize -> range indices"
      pattern: "\\.range\\("
    - from: "src/app/[locale]/(admin)/admin/(panel)/clients/pagination-controls.tsx"
      to: "URL search params"
      via: "useRouter + useSearchParams"
      pattern: "useSearchParams"
    - from: "src/app/[locale]/(admin)/admin/(panel)/clients/page.tsx"
      to: "pagination-controls.tsx"
      via: "props (currentPage, totalPages, pageSize, totalCount)"
      pattern: "PaginationControls"
---

<objective>
Implement server-side pagination for the admin clients list so it scales to 1000+ clients without loading all profiles at once.

Purpose: The current admin clients page fetches ALL profiles in a single query. With 1000+ clients this will be slow and memory-intensive. Server-side pagination with URL-based state ensures fast page loads and proper browser navigation.

Output: Paginated admin clients list with page navigation, page size controls, and total count display.
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-performance-optimization/07-RESEARCH.md

Key files to reference:
@src/app/[locale]/(admin)/admin/(panel)/clients/page.tsx
@src/app/[locale]/(admin)/admin/(panel)/clients/clients-list.tsx
@src/components/ui/select.tsx
@src/messages/en.json
@src/messages/ar.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install pagination component and create pagination controls</name>
  <files>
    src/components/ui/pagination.tsx
    src/app/[locale]/(admin)/admin/(panel)/clients/pagination-controls.tsx
    src/messages/en.json
    src/messages/ar.json
  </files>
  <action>
1. Install shadcn/ui pagination component:
   ```bash
   npx shadcn@latest add pagination
   ```
   This creates `src/components/ui/pagination.tsx` with PaginationContent, PaginationItem, PaginationLink, PaginationNext, PaginationPrevious, PaginationEllipsis.

2. Create `src/app/[locale]/(admin)/admin/(panel)/clients/pagination-controls.tsx` as a "use client" component:

   Props interface:
   ```typescript
   interface PaginationControlsProps {
     currentPage: number;
     totalPages: number;
     pageSize: number;
     totalCount: number;
   }
   ```

   Implementation details:
   - Import `useRouter` and `useSearchParams` from `next/navigation`
   - Import `useTranslations` from `next-intl`
   - Import shadcn/ui Pagination components and Select component
   - `updatePage(newPage: number)` function: creates URLSearchParams from current, sets "page", pushes via router
   - `updatePageSize(newSize: string)` function: sets "pageSize" AND resets "page" to "1" (critical - see research pitfall #3), pushes via router
   - Render layout: flex container with items-center justify-between
     - Left side: Select dropdown for page size (10, 25, 50, 100 options). Use existing shadcn Select component. Label format from i18n: "{size} / page"
     - Center: shadcn Pagination with smart page number display:
       - Always show page 1 and last page
       - Show current page +/- 1 neighbor
       - Use PaginationEllipsis for gaps
       - PaginationPrevious disabled when page === 1
       - PaginationNext disabled when page >= totalPages
     - Right side: Text showing "Showing X-Y of Z" (e.g., "Showing 1-25 of 342") using i18n

   - Use `useTranslations("admin")` for all text labels
   - Style to match the admin panel's clean design (stone colors, rounded borders, consistent with existing table styling)

3. Add i18n keys to `src/messages/en.json` under the "admin" namespace:
   ```json
   "page": "Page",
   "perPage": "per page",
   "showing": "Showing",
   "of": "of",
   "previous": "Previous",
   "next": "Next"
   ```

4. Add corresponding Arabic translations to `src/messages/ar.json` under "admin":
   ```json
   "page": "صفحة",
   "perPage": "لكل صفحة",
   "showing": "عرض",
   "of": "من",
   "previous": "السابق",
   "next": "التالي"
   ```
  </action>
  <verify>
    - `src/components/ui/pagination.tsx` exists after shadcn install
    - `src/app/[locale]/(admin)/admin/(panel)/clients/pagination-controls.tsx` exists with "use client" directive
    - `pnpm tsc --noEmit` passes (no type errors)
    - en.json and ar.json both have the 6 new admin keys (page, perPage, showing, of, previous, next)
  </verify>
  <done>
    PaginationControls component created with page navigation (Previous/Next + page numbers with ellipsis), page size selector (10/25/50/100), and "Showing X-Y of Z" display. All text internationalized in both English and Arabic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add server-side pagination to admin clients page</name>
  <files>
    src/app/[locale]/(admin)/admin/(panel)/clients/page.tsx
    src/app/[locale]/(admin)/admin/(panel)/clients/clients-list.tsx
  </files>
  <action>
1. Refactor `src/app/[locale]/(admin)/admin/(panel)/clients/page.tsx`:

   - Add searchParams prop (Next.js 16+ pattern - searchParams is a Promise):
     ```typescript
     interface PageProps {
       searchParams: Promise<{ page?: string; pageSize?: string }>;
     }
     ```
   - Await searchParams at top of function
   - Parse page (default 1) and pageSize (default 25) with parseInt, clamp to valid ranges:
     - page: Math.max(1, parsed)
     - pageSize: must be one of [10, 25, 50, 100], default to 25 if invalid
   - Calculate range indices (zero-based inclusive):
     ```typescript
     const from = (page - 1) * pageSize;
     const to = from + pageSize - 1;
     ```
   - Update Supabase query to use `.range()` with estimated count:
     ```typescript
     const { data: clients, count } = await supabase
       .from("profiles")
       .select("id,full_name,phone,status,plan_tier,plan_start_date,plan_end_date,created_at", { count: 'estimated' })
       .eq("is_coach", false)
       .order("created_at", { ascending: false })
       .range(from, to);
     ```
     IMPORTANT: `.order()` MUST come before `.range()` for consistent pagination (research pitfall #2).
   - Calculate totalPages: `Math.ceil((count ?? 0) / pageSize)`
   - Update the header subtitle to show total count from `count` (not `clients.length`): "{count} total clients"
   - Render ClientsList with just `clients` prop (same as before)
   - Render PaginationControls below ClientsList:
     ```tsx
     <PaginationControls
       currentPage={page}
       totalPages={totalPages}
       pageSize={pageSize}
       totalCount={count ?? 0}
     />
     ```
   - Wrap PaginationControls in `<Suspense>` since it uses `useSearchParams` (Next.js requirement for client components using useSearchParams in Server Component trees)

2. Update `src/app/[locale]/(admin)/admin/(panel)/clients/clients-list.tsx`:
   - The ClientsList component keeps its existing client-side search filtering (searches within the current page only - this is expected behavior for paginated lists)
   - No structural changes needed to this component. The search filters the `clients` prop which now contains only the current page's clients instead of all clients.
   - Note: The search input placeholder and empty state already exist and work correctly.
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - `pnpm build` succeeds
    - Visit `/en/admin/clients` - shows first 25 clients with pagination controls at bottom
    - Visit `/en/admin/clients?page=2` - shows next 25 clients
    - Visit `/en/admin/clients?pageSize=10` - shows 10 clients per page
    - Changing page size resets to page 1
    - Header shows total count (e.g., "342 total clients")
    - Browser back button returns to previous page state
  </verify>
  <done>
    Admin clients page uses server-side pagination via Supabase `.range()` with `count: 'estimated'`. Only one page of clients loaded per request. URL-based pagination state enables browser back/forward. Total count displayed in header. Search filters within current page.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` - Zero type errors
2. `pnpm build` - Production build succeeds
3. Admin clients page loads without fetching all profiles (check Network tab - response should contain only pageSize items)
4. Pagination controls render with correct page numbers
5. Page size selector works (10, 25, 50, 100)
6. "Showing X-Y of Z" text displays correctly
7. URL reflects pagination state (?page=2&pageSize=25)
8. Browser back/forward navigates pagination history
</verification>

<success_criteria>
- Admin clients list fetches only `pageSize` profiles per page load via `.range()`
- Pagination controls show page navigation with Previous/Next and numbered pages
- Page size selector allows 10/25/50/100 items per page
- Total client count shown in header (from `count: 'estimated'`)
- Changing page size resets to page 1
- All pagination UI text translated in both English and Arabic
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-optimization/07-01-SUMMARY.md`
</output>
