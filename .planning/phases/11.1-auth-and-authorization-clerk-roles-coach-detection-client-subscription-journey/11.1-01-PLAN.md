---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/pendingSignups.ts
  - convex/clerkActions.ts
  - convex/email.ts
  - convex/http.ts
  - convex/systemConfig.ts
autonomous: true
requirements:
  - CLERK-ROLES
  - SIGNUP-FLOW
  - APPROVAL-FLOW
  - REJECTION-FLOW
  - PLANS-CONFIG

must_haves:
  truths:
    - "Convex pendingSignups schema includes rejectionReason and clerkInvitationId fields"
    - "approveSignup mutation schedules a Clerk invitation via internalAction"
    - "rejectSignup action deletes Clerk user (if exists), revokes invitation, and sends rejection email"
    - "Convex HTTP endpoint provides unauthenticated upload URL for marketing checkout"
    - "systemConfig has a getPlans query returning coach-configurable pricing plan data"
  artifacts:
    - path: "convex/clerkActions.ts"
      provides: "Clerk Backend API integration (sendInvitation, deleteUser, revokeInvitation)"
      exports: ["sendInvitation", "deleteUserAndInvitation"]
    - path: "convex/schema.ts"
      provides: "Updated pendingSignups table with rejectionReason, clerkInvitationId"
      contains: "rejectionReason"
    - path: "convex/http.ts"
      provides: "Public upload URL endpoint for marketing app"
      contains: "/marketing/upload-url"
  key_links:
    - from: "convex/pendingSignups.ts"
      to: "convex/clerkActions.ts"
      via: "ctx.scheduler.runAfter(0, internal.clerkActions.sendInvitation, ...)"
      pattern: "internal\\.clerkActions\\.sendInvitation"
    - from: "convex/clerkActions.ts"
      to: "@clerk/backend"
      via: "createClerkClient().invitations.createInvitation"
      pattern: "createInvitation"

user_setup:
  - service: clerk
    why: "Clerk Backend API for invitations and user management"
    env_vars:
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys -> Secret Key. Must be set in Convex: npx convex env set CLERK_SECRET_KEY sk_..."
      - name: CLIENT_APP_URL
        source: "The client app URL (e.g., http://localhost:3000 for dev). Must be set in Convex: npx convex env set CLIENT_APP_URL http://localhost:3000"
---

<objective>
Set up the Convex backend infrastructure for the full client acquisition flow: schema updates, Clerk invitation actions, rejection flow with user cleanup, public upload URL for marketing, and coach-configurable pricing plans.

Purpose: All frontend work (marketing app, client accept-invite, admin approvals) depends on these backend mutations/actions existing first. This is the foundational data layer.
Output: Updated Convex schema, new clerkActions.ts file, updated pendingSignups.ts, updated http.ts with public upload endpoint, updated systemConfig with plans query.
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-RESEARCH.md
@convex/schema.ts
@convex/pendingSignups.ts
@convex/http.ts
@convex/email.ts
@convex/systemConfig.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Convex schema and create Clerk actions module</name>
  <files>
    convex/schema.ts
    convex/clerkActions.ts
  </files>
  <action>
**Schema updates in `convex/schema.ts`:**
- Add `rejectionReason: v.optional(v.string())` to the `pendingSignups` table
- Add `clerkInvitationId: v.optional(v.string())` to the `pendingSignups` table (for revoking on rejection)

**Create `convex/clerkActions.ts`:**
- File MUST start with `"use node";` (Clerk Backend API requires Node.js runtime)
- Import `internalAction` from `./_generated/server` and `v` from `convex/values`
- Import `internal` from `./_generated/api`

**`sendInvitation` internalAction:**
- Args: `email: v.string(), fullName: v.string(), signupId: v.id("pendingSignups")`
- Handler:
  1. `const { createClerkClient } = await import("@clerk/backend");`
  2. Create client with `process.env.CLERK_SECRET_KEY!`
  3. Call `clerkClient.invitations.createInvitation({ emailAddress: email, redirectUrl: \`\${process.env.CLIENT_APP_URL}/en/accept-invite\`, publicMetadata: { signupId, fullName }, notify: true })`
  4. Store the returned `invitation.id` back on the signup record: `await ctx.runMutation(internal.pendingSignups.patchInvitationId, { signupId, clerkInvitationId: invitation.id })`
- Return type: `Promise<void>` (explicit annotation to avoid TS7022)

**`deleteUserAndInvitation` internalAction:**
- Args: `email: v.string(), clerkInvitationId: v.optional(v.string())`
- Handler:
  1. Create Clerk client same as above
  2. Find user by email: `clerkClient.users.getUserList({ emailAddress: [email] })`
  3. If user found, delete: `clerkClient.users.deleteUser(users.data[0].id)`
  4. If `clerkInvitationId` provided, revoke: `clerkClient.invitations.revokeInvitation(clerkInvitationId)` — wrap in try/catch (invitation may already be consumed)
  </action>
  <verify>Run `npx convex dev` and verify no TypeScript errors. Check that the schema migration runs cleanly (existing pendingSignups data is backward-compatible since new fields are optional).</verify>
  <done>convex/clerkActions.ts exists with sendInvitation and deleteUserAndInvitation internalActions. pendingSignups schema has rejectionReason and clerkInvitationId fields.</done>
</task>

<task type="auto">
  <name>Task 2: Update pendingSignups mutations, email, HTTP upload endpoint, and plans config</name>
  <files>
    convex/pendingSignups.ts
    convex/email.ts
    convex/http.ts
    convex/systemConfig.ts
  </files>
  <action>
**Update `convex/pendingSignups.ts`:**

1. Add a new `patchInvitationId` internalMutation:
   - Args: `signupId: v.id("pendingSignups"), clerkInvitationId: v.string()`
   - Handler: `ctx.db.patch(signupId, { clerkInvitationId })`

2. Update `approveSignup` mutation:
   - After patching status to "approved", schedule Clerk invitation:
   - `await ctx.scheduler.runAfter(0, internal.clerkActions.sendInvitation, { email: signup.email, fullName: signup.fullName, signupId })`
   - Remove the existing `sendWelcomeEmail` scheduler call (the Clerk invitation email replaces it)

3. Convert `rejectSignup` from mutation to action (needs Node.js for Clerk API):
   - Actually, keep it as a mutation but schedule the Clerk cleanup as a separate internalAction
   - Add `rejectionReason: v.string()` to args
   - Patch signup: `{ status: "rejected", reviewedAt: Date.now(), rejectionReason }`
   - Schedule cleanup: `ctx.scheduler.runAfter(0, internal.clerkActions.deleteUserAndInvitation, { email: signup.email, clerkInvitationId: signup.clerkInvitationId })`
   - Schedule rejection email: `ctx.scheduler.runAfter(0, internal.email.sendRejectionEmail, { email: signup.email, fullName: signup.fullName, rejectionReason, language: "en" })`

4. Update `createSignup` mutation:
   - Add `planId: v.optional(v.string())` to args (tracks which pricing plan the client selected)
   - Store `planId` in the insert

5. Add `getSignupById` query:
   - Args: `signupId: v.id("pendingSignups")`
   - Auth check (coach only)
   - Returns single signup record for the detail page

**Update `convex/email.ts`:**
- Add `sendRejectionEmail` internalAction:
  - Args: `email, fullName, rejectionReason, language`
  - Uses Resend (same pattern as existing `sendWelcomeEmail`)
  - Subject: "Your FitFast Application Update"
  - Body: Polite message saying application wasn't approved, includes rejectionReason, encourages to reapply

**Update `convex/http.ts`:**
- Add a new HTTP POST route at path `/marketing/upload-url`:
  - Handler: `httpAction(async (ctx, _request) => { const uploadUrl = await ctx.storage.generateUploadUrl(); return new Response(JSON.stringify({ uploadUrl }), { status: 200, headers: { "Content-Type": "application/json", "Access-Control-Allow-Origin": "*" } }); })`
  - Also add OPTIONS handler for CORS preflight on same path

**Update `convex/systemConfig.ts`:**
- Add `getPlans` query (public, no auth required — marketing page needs this):
  - Reads systemConfig with key `"plans"`, returns value or default empty array
- Add `updatePlans` mutation (coach-only):
  - Args: `plans: v.array(v.object({ id: v.string(), name: v.string(), nameAr: v.string(), price: v.number(), currency: v.string(), duration: v.string(), durationAr: v.string(), features: v.array(v.string()), featuresAr: v.array(v.string()), badge: v.optional(v.string()), badgeAr: v.optional(v.string()) }))`
  - Upserts the "plans" config key
- Add `getPaymentMethods` query (public — marketing needs this):
  - Reads systemConfig with key `"paymentMethods"`, returns value or default empty array
- Add `updatePaymentMethods` mutation (coach-only):
  - Args: `paymentMethods: v.array(v.object({ type: v.string(), accountName: v.string(), accountNumber: v.string(), instructions: v.optional(v.string()) }))`
  </action>
  <verify>Run `npx convex dev` and verify all mutations/queries/actions compile. Check that `approveSignup` schedules `clerkActions.sendInvitation`. Check that `rejectSignup` schedules both `deleteUserAndInvitation` and `sendRejectionEmail`. Verify HTTP route registered with `console.log` or by checking the Convex dashboard.</verify>
  <done>approveSignup triggers Clerk invitation on approval. rejectSignup stores reason, schedules Clerk user deletion and rejection email. Public upload URL endpoint exists at /marketing/upload-url. getPlans and getPaymentMethods queries return coach-configurable data. createSignup accepts planId.</done>
</task>

</tasks>

<verification>
1. `npx convex dev` runs without errors
2. Schema migration succeeds (new optional fields on pendingSignups)
3. All new queries/mutations/actions are visible in Convex dashboard
4. No TS7022/TS7023 circular type inference errors
</verification>

<success_criteria>
- Convex backend supports the full signup → approve → invite → reject flow
- Clerk invitation is triggered on approval (not welcome email)
- Rejection includes reason, Clerk user cleanup, and rejection email
- Marketing app can get an upload URL without authentication
- Pricing plans and payment methods are coach-configurable via systemConfig
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-01-SUMMARY.md`
</output>
