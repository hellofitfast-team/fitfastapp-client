---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
plan: 05
subsystem: ui
tags: [checkout, vaul, react-hook-form, zod, convex, file-upload, i18n, marketing]

# Dependency graph
requires:
  - phase: 11.1-01
    provides: createSignup mutation, /marketing/upload-url HTTP action, getPaymentMethods query
  - phase: 11.1-02
    provides: marketing app scaffold with Convex provider and @fitfast/ui
  - phase: 11.1-03
    provides: Pricing section with onSelectPlan callback, bilingual message files

provides:
  - Checkout drawer (Vaul) triggered by pricing card CTA
  - Checkout form with react-hook-form + zod v4 (name, email, phone, screenshot upload)
  - File upload to Convex storage via NEXT_PUBLIC_CONVEX_SITE_URL/marketing/upload-url
  - PaymentInstructions component fetching coach-configured payment methods from Convex
  - Confirmation page /[locale]/confirmation with bilingual messaging
  - checkout + confirmation i18n namespaces in en.json + ar.json

affects: [11.1-06, marketing-app, checkout-flow]

# Tech tracking
tech-stack:
  added:
    - react-hook-form@7.71.1 (form state management)
    - "@hookform/resolvers@5.2.2" (zod adapter for react-hook-form)
    - zod@4.3.6 (schema validation via zod/v4)
  patterns:
    - File upload via Convex HTTP action (POST for upload URL, PUT with file to storage URL)
    - Drawer-driven checkout: pricing card → CheckoutDrawer → CheckoutForm → confirmation
    - Drag-and-drop on desktop / tap-to-upload on mobile for file inputs

key-files:
  created:
    - apps/marketing/src/components/checkout/checkout-drawer.tsx
    - apps/marketing/src/components/checkout/checkout-form.tsx
    - apps/marketing/src/components/checkout/payment-instructions.tsx
    - "apps/marketing/src/app/[locale]/confirmation/page.tsx"
  modified:
    - apps/marketing/src/components/sections/pricing.tsx
    - apps/marketing/src/messages/en.json
    - apps/marketing/src/messages/ar.json
    - convex/_generated/api.d.ts
    - .env.example

key-decisions:
  - "Pricing section owns drawer state — no changes to page.tsx required. Self-contained component."
  - "NEXT_PUBLIC_CONVEX_SITE_URL (ending in .convex.site) added as separate env var for HTTP actions"
  - "Screenshot upload is optional — signup can proceed without payment proof uploaded"
  - "Zod v4 import uses 'zod/v4' subpath — required for v4 API with @hookform/resolvers v5"

patterns-established:
  - "Convex file upload pattern: POST /marketing/upload-url → PUT response.uploadUrl with file → response.storageId"
  - "Checkout drawer: open/selectedPlan state in parent (Pricing), form submission navigates to confirmation"

requirements-completed:
  - CHECKOUT-DRAWER
  - CHECKOUT-FORM
  - PAYMENT-UPLOAD
  - PAYMENT-METHODS
  - CONFIRMATION-PAGE

# Metrics
duration: 35min
completed: 2026-02-20
---

# Phase 11.1 Plan 05: Checkout Flow Summary

**Vaul checkout drawer with react-hook-form + zod v4, Convex file upload to storage, and bilingual confirmation page completing the prospect funnel**

## Performance

- **Duration:** 35 min
- **Started:** 2026-02-20T00:00:00Z
- **Completed:** 2026-02-20T00:35:00Z
- **Tasks:** 2
- **Files modified:** 9 (4 created, 5 modified)

## Accomplishments

- Checkout drawer (Vaul-based via @fitfast/ui/drawer) opens when "Choose This Plan" is clicked on any pricing card
- Checkout form with full validation (name min 2, email format, phone min 10), drag-and-drop file upload with preview
- File upload flow: POST to /marketing/upload-url for signed URL, PUT file to Convex storage, storageId passed to createSignup mutation
- PaymentInstructions component fetches coach-configured payment methods in real time from Convex
- Confirmation page with CheckCircle2 icon in royal blue, bilingual messaging, 24-48h approval timeline note
- Full bilingual support (checkout + confirmation namespaces) in en.json and ar.json

## Task Commits

1. **Task 1: Checkout drawer, form, payment instructions** - `13727b8` (feat)
2. **Task 2: Wire pricing cards and confirmation page** - `a86d5b8` (feat)

## Files Created/Modified

- `apps/marketing/src/components/checkout/checkout-drawer.tsx` - Vaul drawer wrapping checkout form with plan details in header
- `apps/marketing/src/components/checkout/checkout-form.tsx` - Form with react-hook-form + zod v4, file upload zone, submit flow
- `apps/marketing/src/components/checkout/payment-instructions.tsx` - Coach payment methods from Convex systemConfig
- `apps/marketing/src/app/[locale]/confirmation/page.tsx` - Post-submission success page with bilingual messaging
- `apps/marketing/src/components/sections/pricing.tsx` - Added drawer state, handleSelectPlan, handleSuccess, CheckoutDrawer render
- `apps/marketing/src/messages/en.json` - Added checkout and confirmation namespaces
- `apps/marketing/src/messages/ar.json` - Added Arabic checkout and confirmation translations
- `convex/_generated/api.d.ts` - Added missing clerkActions import and type entry (pre-existing blocking issue)
- `.env.example` - Added NEXT_PUBLIC_CONVEX_SITE_URL documentation

## Decisions Made

- Pricing section owns drawer state (selectedPlan, drawerOpen) — no changes to page.tsx required
- NEXT_PUBLIC_CONVEX_SITE_URL as a separate env var from NEXT_PUBLIC_CONVEX_URL — .convex.site domain for HTTP actions
- Screenshot upload is optional — signup can proceed without payment proof
- Zod v4 uses `"zod/v4"` subpath import to access v4 API with @hookform/resolvers v5

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added clerkActions to convex/_generated/api.d.ts**
- **Found during:** Task 1 (build verification)
- **Issue:** `clerkActions.ts` was added in plan 11.1-04 but never added to the generated API type declarations. This caused `internal.clerkActions` to be `unknown`, producing TS2339 errors that blocked the entire marketing app build.
- **Fix:** Added `import type * as clerkActions from "../clerkActions.js"` and `clerkActions: typeof clerkActions` to `api.d.ts`
- **Files modified:** `convex/_generated/api.d.ts`
- **Verification:** `pnpm --filter @fitfast/marketing build` succeeds — both `/[locale]` and `/[locale]/confirmation` routes compile
- **Committed in:** `13727b8` (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Fix essential — without it the marketing app wouldn't build. Minimal scope (2 lines added to generated type file). No scope creep.

## Issues Encountered

None beyond the blocking deviation documented above.

## User Setup Required

**Environment variable needed:**
- `NEXT_PUBLIC_CONVEX_SITE_URL` — the Convex HTTP action URL (`https://your-deployment.convex.site`). Documented in `.env.example`. Required for the screenshot upload flow.

## Next Phase Readiness

- Complete prospect funnel is live: landing page → pricing → checkout drawer → form submission → confirmation
- Convex backend (plan 01) handles invitation emails after coach approval
- Plan 06 (if any) can build on this foundation for admin signup management UI

---
*Phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey*
*Completed: 2026-02-20*
