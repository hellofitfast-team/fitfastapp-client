---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
plan: 04
subsystem: auth
tags: [clerk, jwt, rbac, middleware, next-intl, convex, tailwind, css-layers]

# Dependency graph
requires:
  - phase: 11.1-01
    provides: Convex backend with pendingSignups and Clerk invitation flow

provides:
  - Admin middleware with Clerk JWT role check (metadata.role === 'coach')
  - CustomJwtSessionClaims TypeScript type declaration for admin app
  - Accept-invite page using Clerk ticket strategy for invitation acceptance
  - Pending page with Convex real-time auto-redirect on approval/rejection
  - Tailwind v4 + Clerk CSS layer conflict resolution

affects:
  - Admin panel access control
  - Client onboarding flow (accept-invite -> pending -> initial-assessment)
  - Clerk CSS rendering in client PWA

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Clerk JWT role check in middleware (sessionClaims.metadata.role) — no DB query required
    - CSS @layer ordering for Tailwind v4 + Clerk compatibility (clerk layer between base and components)
    - Convex real-time subscription for auto-redirect (profile status change triggers useEffect)
    - Clerk ticket strategy for invitation acceptance (signUp.create({ strategy: 'ticket', ticket }))

key-files:
  created:
    - apps/admin/src/types/globals.d.ts
    - apps/client/src/app/[locale]/(auth)/accept-invite/page.tsx
  modified:
    - apps/admin/src/middleware.ts
    - apps/client/src/app/globals.css
    - apps/client/src/components/providers/convex-provider.tsx
    - apps/client/src/app/[locale]/(onboarding)/pending/page.tsx
    - apps/client/src/messages/en.json
    - apps/client/src/messages/ar.json

key-decisions:
  - "Admin middleware uses Clerk JWT sessionClaims.metadata.role for coach check — fast, no DB query, defense-in-depth on top of layout-level isCoach check"
  - "Pending page trusts Convex real-time subscription entirely — no manual refresh button needed since useQuery reactively updates on approval"
  - "ClerkProvider cssLayerName: 'clerk' + @layer declaration in globals.css resolves Tailwind v4 cascade conflict"

patterns-established:
  - "Clerk JWT role check pattern: (sessionClaims as CustomJwtSessionClaims)?.metadata?.role in middleware"
  - "Real-time status auto-redirect: useEffect watching profile.status from Convex query"
  - "Accept invitation: useSignUp with strategy: 'ticket' + ticket param"

requirements-completed:
  - CLERK-ROLES
  - COACH-DETECTION
  - ACCEPT-INVITE
  - PENDING-REALTIME

# Metrics
duration: 22min
completed: 2026-02-20
---

# Phase 11.1 Plan 04: Admin RBAC + Accept-Invite + Real-Time Pending Summary

**Clerk JWT role-based admin RBAC, invitation acceptance via ticket strategy, and real-time Convex auto-redirect on pending approval**

## Performance

- **Duration:** 22 min
- **Started:** 2026-02-20T20:21:17Z
- **Completed:** 2026-02-20T20:43:17Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments

- Admin middleware now rejects non-coach users at JWT level with `metadata.role !== 'coach'` check — no database query needed
- New accept-invite page handles Clerk invitation ticket flow: shows password form, creates account via `signUp.create({ strategy: 'ticket', ticket })`, redirects to pending on completion
- Pending page upgraded: real-time Convex subscription auto-redirects to `/initial-assessment` on approval (or `/login?error=rejected` on rejection) — no manual "Check Status" button
- Tailwind v4 + Clerk CSS conflict resolved via `@layer theme, base, clerk, components, utilities` declaration and `cssLayerName: 'clerk'` on ClerkProvider

## Task Commits

Each task was committed atomically:

1. **Task 1: Admin RBAC middleware and CSS layer fix** - `355cdcb` (feat)
2. **Task 2: Accept-invite page and real-time pending page** - `d840cb4` (feat)

## Files Created/Modified

- `apps/admin/src/middleware.ts` — Clerk JWT role check added, non-coach redirect to `/login?error=not_coach`
- `apps/admin/src/types/globals.d.ts` — CustomJwtSessionClaims interface declaration
- `apps/client/src/app/globals.css` — Added `@layer theme, base, clerk, components, utilities` before `@import "tailwindcss"`
- `apps/client/src/components/providers/convex-provider.tsx` — Added `appearance={{ cssLayerName: "clerk" }}` to ClerkProvider
- `apps/client/src/app/[locale]/(auth)/accept-invite/page.tsx` — New page: Clerk ticket invitation acceptance with password form
- `apps/client/src/app/[locale]/(onboarding)/pending/page.tsx` — Updated: real-time auto-redirect, updated stepper, removed manual check button
- `apps/client/src/messages/en.json` — Added acceptInvite, createAccount, invalidInviteLink, inviteExpired, passwordsMustMatch + pending stepper strings
- `apps/client/src/messages/ar.json` — Arabic equivalents for all new strings

## Decisions Made

- Admin middleware uses Clerk JWT `sessionClaims.metadata.role` for coach check — fast path, no DB query, defense-in-depth approach on top of layout-level `profile.isCoach` check
- Pending page trusts Convex real-time entirely — `useQuery` reactively updates when coach approves, `useEffect` watches `profile.status` to trigger redirect. No polling needed.
- `ClerkProvider cssLayerName: 'clerk'` + `@layer` declaration in globals.css is the canonical Tailwind v4 + Clerk compatibility solution

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

Pre-existing TypeScript errors in `convex/pendingSignups.ts` (referencing `internal.clerkActions` before Convex deployment regenerates types) — out of scope, not caused by this plan's changes.

## User Setup Required

None - no external service configuration required. Coach must have `metadata.role: "coach"` set in Clerk Dashboard publicMetadata for middleware to pass them through.

## Next Phase Readiness

- Admin RBAC complete — coach users pass middleware, non-coach users blocked at JWT level
- Accept-invite flow complete — new clients can accept Clerk invitations and set passwords
- Pending page real-time — Convex subscription will auto-redirect clients to initial assessment on approval
- Ready for 11.1-05 (or next wave plans) — full auth journey now functional end-to-end

## Self-Check: PASSED

All 6 files verified to exist. Both task commits (355cdcb, d840cb4) confirmed in git log.

---
*Phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey*
*Completed: 2026-02-20*
