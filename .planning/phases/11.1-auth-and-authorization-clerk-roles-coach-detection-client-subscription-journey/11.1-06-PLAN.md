---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
plan: 06
type: execute
wave: 3
depends_on: ["11.1-01", "11.1-04"]
files_modified:
  - apps/admin/src/app/[locale]/(panel)/signups/[id]/page.tsx
  - apps/admin/src/app/[locale]/(panel)/signups/signups-table.tsx
  - apps/admin/src/app/[locale]/(panel)/settings/settings-form.tsx
  - apps/admin/src/app/[locale]/(panel)/settings/plans-manager.tsx
  - apps/admin/src/app/[locale]/(panel)/settings/payment-methods-manager.tsx
  - apps/admin/src/messages/en.json
  - apps/admin/src/messages/ar.json
autonomous: true
requirements:
  - ADMIN-SIGNUP-DETAIL
  - ADMIN-REJECT-REASON
  - ADMIN-PLANS-CONFIG
  - ADMIN-PAYMENT-METHODS

must_haves:
  truths:
    - "Admin can view signup detail page with payment screenshot displayed"
    - "Admin can reject a signup with a reason input that gets sent in the rejection email"
    - "Admin can configure pricing plans (name, price, duration, features, badge) from settings"
    - "Admin can configure payment methods (account name, number, type, instructions) from settings"
  artifacts:
    - path: "apps/admin/src/app/[locale]/(panel)/signups/[id]/page.tsx"
      provides: "Signup detail view with payment screenshot display"
      contains: "getSignupById"
    - path: "apps/admin/src/app/[locale]/(panel)/settings/plans-manager.tsx"
      provides: "CRUD interface for coach-configurable pricing plans"
      contains: "updatePlans"
    - path: "apps/admin/src/app/[locale]/(panel)/settings/payment-methods-manager.tsx"
      provides: "CRUD interface for payment method configuration"
      contains: "updatePaymentMethods"
  key_links:
    - from: "apps/admin/src/app/[locale]/(panel)/signups/signups-table.tsx"
      to: "convex/pendingSignups.ts"
      via: "useMutation(api.pendingSignups.rejectSignup) with rejectionReason"
      pattern: "rejectSignup.*rejectionReason"
    - from: "apps/admin/src/app/[locale]/(panel)/signups/[id]/page.tsx"
      to: "convex/pendingSignups.ts"
      via: "useQuery(api.pendingSignups.getSignupById)"
      pattern: "getSignupById"
---

<objective>
Build admin panel enhancements: signup detail page with payment screenshot, rejection reason input, and settings for coach-configurable pricing plans and payment methods.

Purpose: The coach needs to inspect payment screenshots, approve/reject with reasons, and configure what prospects see on the marketing landing page. This closes the admin side of the acquisition loop.
Output: Signup detail page, updated rejection flow, plans management, and payment methods management in admin settings.
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-RESEARCH.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-01-SUMMARY.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-04-SUMMARY.md
@apps/admin/src/app/[locale]/(panel)/signups/signups-table.tsx
@apps/admin/src/app/[locale]/(panel)/settings/settings-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create signup detail page and update signups table with rejection reason</name>
  <files>
    apps/admin/src/app/[locale]/(panel)/signups/[id]/page.tsx
    apps/admin/src/app/[locale]/(panel)/signups/signups-table.tsx
    apps/admin/src/messages/en.json
    apps/admin/src/messages/ar.json
  </files>
  <action>
**Create signup detail page (`signups/[id]/page.tsx`):**
- "use client" component
- Uses `useQuery(api.pendingSignups.getSignupById, { signupId })` to fetch signup details
- Uses `useParams()` to get the signup ID from the URL
- Layout:
  1. Back button (link to `/signups`)
  2. Signup info card: full name, email, phone, plan tier, status, submission date
  3. Payment screenshot section:
     - If `paymentScreenshotId` exists, get the file URL via Convex storage
     - Use a Convex query or utility to get a URL for the storage ID (e.g., `useQuery(api.storage.getUrl, { storageId })` — check if this exists in the codebase, or use `ctx.storage.getUrl(storageId)` pattern)
     - Display the image in a large preview (click to zoom/expand)
  4. OCR extracted data (if available) — display raw data below screenshot
  5. Action buttons:
     - "Approve" button (calls `approveSignup` mutation)
     - "Reject" button — opens an inline text input for rejection reason
     - When reject reason is submitted, calls `rejectSignup` mutation with `rejectionReason`
  6. If already approved/rejected, show status badge and hide action buttons
     - If rejected, show the rejection reason

**Update signups table (`signups-table.tsx`):**
- Add a "View Details" link button per row that navigates to `/signups/${signup._id}`
- Update the reject action to include a reason input:
  - When "Reject" is clicked, show an inline input field or a small dialog/popover asking for rejection reason
  - Submit calls `useMutation(api.pendingSignups.rejectSignup)` with `{ signupId, rejectionReason }`
  - The rejectionReason arg is now required (update the mutation call)
- Keep the existing "Approve" quick action button

**i18n:** Add strings for signupDetail namespace: backToList, signupInfo, paymentScreenshot, ocrData, approve, reject, rejectionReason, rejectionReasonPlaceholder, approved, rejected, pending, viewDetails
  </action>
  <verify>Run admin app. Navigate to signups page. Click "View Details" on a signup — should navigate to detail page. Verify payment screenshot displays (if one exists). Test rejection flow: click reject → enter reason → submit → signup status changes to rejected.</verify>
  <done>Signup detail page shows full signup info with payment screenshot. Reject action requires a reason input. Both list and detail views support approve/reject with full data display.</done>
</task>

<task type="auto">
  <name>Task 2: Build plans manager and payment methods manager in admin settings</name>
  <files>
    apps/admin/src/app/[locale]/(panel)/settings/settings-form.tsx
    apps/admin/src/app/[locale]/(panel)/settings/plans-manager.tsx
    apps/admin/src/app/[locale]/(panel)/settings/payment-methods-manager.tsx
    apps/admin/src/messages/en.json
    apps/admin/src/messages/ar.json
  </files>
  <action>
**Plans Manager (`plans-manager.tsx`):**
- "use client" component
- Uses `useQuery(api.systemConfig.getPlans)` to load current plans
- Uses `useMutation(api.systemConfig.updatePlans)` to save changes
- UI: A list of plan cards with inline editing capability
- Each plan card has fields:
  - Name (EN) + Name (AR) — two text inputs side by side
  - Price (number) + Currency (text, default "EGP")
  - Duration (EN) + Duration (AR) — e.g., "3 months" / "3 أشهر"
  - Features list (EN) — dynamic list with add/remove, text inputs
  - Features list (AR) — corresponding Arabic features
  - Badge (optional) — select dropdown: null, "Most Popular", "Best Value"
  - Badge (AR) (optional) — corresponding Arabic text
- "Add Plan" button (max 4 plans enforced in UI)
- "Remove Plan" button per card (with confirmation)
- "Save All Plans" button at the bottom
- Validation: name required, price > 0, at least 1 feature
- Show toast on save success/failure

**Payment Methods Manager (`payment-methods-manager.tsx`):**
- "use client" component
- Uses `useQuery(api.systemConfig.getPaymentMethods)` to load current methods
- Uses `useMutation(api.systemConfig.updatePaymentMethods)` to save
- UI: List of payment method cards with inline editing
- Each card has fields:
  - Type — select: "InstaPay", "Vodafone Cash", "Orange Cash", "Etisalat Cash", "CIB", "Other"
  - Account Name — text input
  - Account Number — text input
  - Instructions (optional) — textarea for any additional instructions
- "Add Payment Method" button
- "Remove" button per card
- "Save" button

**Update settings-form.tsx:**
- Add two new sections/tabs to the existing settings page:
  - "Pricing Plans" section — renders `<PlansManager />`
  - "Payment Methods" section — renders `<PaymentMethodsManager />`
- Keep all existing settings sections intact

**i18n:** Add strings under settings namespace: pricingPlans, paymentMethods, addPlan, removePlan, savePlans, planName, planNameAr, price, currency, duration, durationAr, features, featuresAr, badge, badgeAr, maxPlansReached, addPaymentMethod, removeMethod, savePaymentMethods, accountType, accountName, accountNumber, instructions
  </action>
  <verify>Run admin app. Navigate to settings. Verify Plans Manager section appears with add/remove/edit capability. Add a test plan, save, reload — should persist. Verify Payment Methods Manager works similarly. Check that marketing landing page reflects saved plans (cross-app verification).</verify>
  <done>Admin settings has Plans Manager (CRUD for pricing plans, max 4, bilingual) and Payment Methods Manager (CRUD for payment methods). Data persists in Convex systemConfig and is reflected on the marketing landing page.</done>
</task>

</tasks>

<verification>
1. Signup detail page renders with payment screenshot
2. Reject action requires and stores rejection reason
3. Plans manager allows CRUD for up to 4 pricing plans with bilingual fields
4. Payment methods manager allows CRUD for payment methods
5. Saved plans appear on the marketing landing page pricing section
6. All new strings exist in both en.json and ar.json
</verification>

<success_criteria>
- Coach can inspect payment screenshots in signup detail view
- Coach can reject signups with a reason that gets emailed to the prospect
- Coach can configure pricing plans that dynamically appear on the marketing page
- Coach can configure payment method details that prospects see during checkout
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-06-SUMMARY.md`
</output>
