---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
plan: "07"
subsystem: testing
tags: [e2e, integration, clerk, convex, marketing, admin, client, i18n]

# Dependency graph
requires:
  - phase: 11.1-04
    provides: Admin RBAC, accept-invite page, real-time pending page
  - phase: 11.1-05
    provides: Checkout drawer, file upload, confirmation page on marketing site
  - phase: 11.1-06
    provides: Signup detail page, plans manager, payment methods manager in admin
provides:
  - End-to-end verified client acquisition flow across all three apps
  - Bug fixes for admin auth race condition, middleware JWT fallback, route paths, marketing i18n
affects:
  - All future phases — confirms foundation is stable

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Wait for isConvexAuth before querying profile in admin login (Clerk+Convex race fix)
    - Clerk middleware fallback to clerkClient API when JWT session token lacks publicMetadata
    - setRequestLocale() required in all server components for next-intl

key-files:
  created: []
  modified:
    - apps/admin/src/middleware.ts
    - apps/admin/src/app/[locale]/(panel)/layout.tsx
    - apps/admin/src/app/[locale]/(panel)/page.tsx
    - apps/admin/src/app/[locale]/login/page.tsx
    - apps/admin/src/components/admin-header.tsx
    - apps/admin/src/components/admin-sidebar.tsx
    - apps/admin/src/app/[locale]/(panel)/clients/[id]/page.tsx
    - apps/marketing/src/app/[locale]/layout.tsx
    - apps/marketing/src/app/[locale]/page.tsx
    - apps/marketing/src/app/layout.tsx
    - apps/marketing/src/app/[locale]/confirmation/page.tsx

key-decisions:
  - "E2E testing done manually across all 3 apps — no Playwright due to Clerk auth wall complexity"
  - "Admin middleware falls back to clerkClient API when JWT lacks publicMetadata — handles uncustomized session tokens"
  - "Admin sidebar links use root-relative paths without /admin prefix — matches (panel) route group structure"

patterns-established:
  - "Clerk+Convex auth race: gate Convex queries on isConvexAuth before checking profile"
  - "Marketing server components must call setRequestLocale(locale) for next-intl"
  - "Admin route group (panel) means sidebar links are /signups not /admin/signups"

requirements-completed:
  - END-TO-END-FLOW

# Metrics
duration: 35min
completed: 2026-02-20
---

# Phase 11.1 Plan 07: End-to-End Client Acquisition Verification Summary

**Manual E2E verification of full acquisition circle with 6 bug fixes — admin auth race, JWT fallback, route paths, and marketing i18n**

## Performance

- **Duration:** 35 min
- **Started:** 2026-02-20T21:00:00Z
- **Completed:** 2026-02-20T21:35:00Z
- **Tasks:** 1 (human verification checkpoint)
- **Files modified:** 11

## Accomplishments

- Verified full client acquisition circle: marketing checkout -> admin approval -> Clerk invitation -> accept-invite -> pending -> initial assessment
- Fixed Clerk+Convex auth race condition in admin login — queries now wait for `isConvexAuth` before checking profile
- Fixed admin middleware to fall back to `clerkClient` API when JWT session token doesn't include publicMetadata
- Fixed all admin sidebar/page links to remove `/admin` prefix matching `(panel)` route group
- Fixed marketing i18n: added `setRequestLocale` to all server components and moved `<html>` to `[locale]/layout.tsx`

## Task Commits

1. **Task 1: E2E verification + bug fixes** - `c144c87` (fix)

## Files Created/Modified

- `apps/admin/src/middleware.ts` — JWT fallback to clerkClient API for publicMetadata
- `apps/admin/src/app/[locale]/(panel)/layout.tsx` — Admin shell layout created
- `apps/admin/src/app/[locale]/(panel)/page.tsx` — Admin dashboard page created
- `apps/admin/src/app/[locale]/login/page.tsx` — Login page with Convex auth race fix
- `apps/admin/src/components/admin-header.tsx` — Header component created
- `apps/admin/src/components/admin-sidebar.tsx` — Sidebar links fixed (no /admin prefix)
- `apps/admin/src/app/[locale]/(panel)/clients/[id]/page.tsx` — Client detail page created
- `apps/marketing/src/app/[locale]/layout.tsx` — Moved html tag here with lang/dir attributes
- `apps/marketing/src/app/[locale]/page.tsx` — Added setRequestLocale
- `apps/marketing/src/app/layout.tsx` — Simplified (html tag moved to locale layout)
- `apps/marketing/src/app/[locale]/confirmation/page.tsx` — Added setRequestLocale

## Decisions Made

- E2E testing done manually rather than with Playwright — Clerk auth walls make automated E2E testing complex and brittle
- Admin middleware falls back to `clerkClient` API when JWT session token lacks publicMetadata — handles the case where Clerk session token template hasn't been customized yet
- Admin sidebar links use root-relative paths without `/admin` prefix — the `(panel)` route group means URLs are `/signups`, not `/admin/signups`

## Deviations from Plan

Plan was a human verification checkpoint. All 6 bugs found during testing were fixed in commit `c144c87`.

## Issues Encountered

- Clerk+Convex auth race: admin login page queried Convex profile before Convex had picked up the Clerk JWT — fixed by gating on `isConvexAuth`
- Admin middleware assumed JWT always contains publicMetadata — some Clerk configurations don't customize the session token, so fallback to API was needed
- Marketing server components missing `setRequestLocale()` — next-intl requires this for static rendering

## User Setup Required

None - all fixes are code-level.

## Next Phase Readiness

- Full client acquisition circle verified end-to-end
- Phase 11.1 ready for verification and completion
- All 7 plans executed successfully

## Self-Check: PASSED

Commit c144c87 confirmed in git log. All 11 modified files verified.

---
*Phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey*
*Completed: 2026-02-20*
