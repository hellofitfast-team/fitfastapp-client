---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
plan: 05
type: execute
wave: 3
depends_on: ["11.1-01", "11.1-02", "11.1-03"]
files_modified:
  - apps/marketing/src/components/checkout/checkout-drawer.tsx
  - apps/marketing/src/components/checkout/checkout-form.tsx
  - apps/marketing/src/components/checkout/payment-instructions.tsx
  - apps/marketing/src/app/[locale]/page.tsx
  - apps/marketing/src/app/[locale]/confirmation/page.tsx
  - apps/marketing/src/messages/en.json
  - apps/marketing/src/messages/ar.json
autonomous: true
requirements:
  - CHECKOUT-DRAWER
  - CHECKOUT-FORM
  - PAYMENT-UPLOAD
  - PAYMENT-METHODS
  - CONFIRMATION-PAGE

must_haves:
  truths:
    - "Clicking 'Choose Plan' on a pricing card opens a Vaul drawer with the checkout form"
    - "Checkout form has fields: name, email, phone, and payment screenshot upload"
    - "Payment methods section shows coach-configured accounts from Convex"
    - "Uploading a screenshot shows a preview before form submission"
    - "On successful submission, user sees confirmation page with 'Check your email' message"
  artifacts:
    - path: "apps/marketing/src/components/checkout/checkout-drawer.tsx"
      provides: "Vaul drawer wrapping the checkout form"
      contains: "Drawer"
    - path: "apps/marketing/src/components/checkout/checkout-form.tsx"
      provides: "Checkout form with file upload and validation"
      contains: "useForm"
    - path: "apps/marketing/src/app/[locale]/confirmation/page.tsx"
      provides: "Post-submission confirmation page"
  key_links:
    - from: "apps/marketing/src/components/checkout/checkout-form.tsx"
      to: "convex/pendingSignups.ts"
      via: "useMutation(api.pendingSignups.createSignup)"
      pattern: "createSignup"
    - from: "apps/marketing/src/components/checkout/checkout-form.tsx"
      to: "convex/http.ts"
      via: "fetch /marketing/upload-url for screenshot upload"
      pattern: "marketing/upload-url"
    - from: "apps/marketing/src/components/checkout/payment-instructions.tsx"
      to: "convex/systemConfig.ts"
      via: "useQuery(api.systemConfig.getPaymentMethods)"
      pattern: "getPaymentMethods"
---

<objective>
Build the checkout flow: Vaul drawer with form (name, email, phone, payment screenshot), dynamic payment method instructions from Convex, file upload via public HTTP endpoint, and confirmation page.

Purpose: This completes the prospect-facing funnel. After viewing pricing, the prospect fills out the checkout form, uploads their payment screenshot, and receives a confirmation to check their email. The Convex backend (plan 01) handles the rest.
Output: Working checkout drawer, file upload to Convex storage, form submission to createSignup, and confirmation page.
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-RESEARCH.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-01-SUMMARY.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-02-SUMMARY.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-03-SUMMARY.md
@convex/pendingSignups.ts
@convex/http.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build checkout drawer, form with file upload, and payment instructions</name>
  <files>
    apps/marketing/src/components/checkout/checkout-drawer.tsx
    apps/marketing/src/components/checkout/checkout-form.tsx
    apps/marketing/src/components/checkout/payment-instructions.tsx
    apps/marketing/src/messages/en.json
    apps/marketing/src/messages/ar.json
  </files>
  <action>
**Install Vaul in marketing app** (if not already): `pnpm --filter @fitfast/marketing add vaul react-hook-form @hookform/resolvers zod`

**Checkout Drawer (`checkout-drawer.tsx`):**
- "use client" component
- Uses `Drawer` from vaul (or from `@fitfast/ui/drawer` if available as a re-export)
- Props: `open: boolean, onOpenChange: (open: boolean) => void, selectedPlan: { id: string, name: string, price: number, currency: string, duration: string } | null`
- Renders a bottom drawer on mobile, side drawer on desktop
- Header: "Complete Your Subscription" / selected plan name + price
- Body: renders `<CheckoutForm>` passing the selected plan
- Close button in header

**Checkout Form (`checkout-form.tsx`):**
- "use client" component
- Uses `react-hook-form` with Zod schema validation
- Props: `selectedPlan: { id, name, price, currency, duration }, onSuccess: () => void`

**Zod schema:**
```typescript
const checkoutSchema = z.object({
  fullName: z.string().min(2).max(100),
  email: z.string().email(),
  phone: z.string().min(10).max(15),
});
```

**Form fields:**
1. Full Name — `Input` from `@fitfast/ui/input`
2. Email — `Input` type="email"
3. Phone Number — `Input` type="tel"
4. Payment Instructions — render `<PaymentInstructions />` component (shows where to send money)
5. Payment Screenshot — file upload zone:
   - Drag-and-drop area on desktop (border-dashed, drop handler)
   - Tap-to-upload on mobile (hidden file input + styled button)
   - Accept only images (image/*)
   - Max size: 5MB
   - Show preview thumbnail after selection
   - Store file in component state

**Submit flow:**
1. Validate form with Zod
2. Upload screenshot to Convex:
   a. `const CONVEX_URL = process.env.NEXT_PUBLIC_CONVEX_URL;`
   b. Fetch upload URL: `POST ${CONVEX_URL.replace('.cloud', '.site')}/marketing/upload-url` (Convex HTTP action URL format)
   c. Actually, the correct URL format for Convex HTTP actions is: `https://{deployment}.convex.site/marketing/upload-url`. Store this as `NEXT_PUBLIC_CONVEX_SITE_URL` env var.
   d. Upload file: `PUT uploadUrl` with file body and `Content-Type` header
   e. Get back `{ storageId }` from the PUT response
3. Call Convex mutation: `useMutation(api.pendingSignups.createSignup)` with `{ fullName, email, phone, planId: selectedPlan.id, paymentScreenshotId: storageId }`
4. On success, call `onSuccess()` which navigates to confirmation page

**Error handling:** Show field-level errors from Zod. Show toast for upload/submission failures.

**Payment Instructions (`payment-instructions.tsx`):**
- "use client" component
- Uses `useQuery(api.systemConfig.getPaymentMethods)` to fetch coach-configured payment methods
- Renders a list of payment options (e.g., "InstaPay: 01012345678", "Vodafone Cash: 01098765432")
- Each method shows: type icon (generic), account name, account number, optional instructions
- Loading skeleton while query loads
- If no methods configured, show "Contact us for payment details"
  </action>
  <verify>Install dependencies. Verify checkout drawer opens when triggered. Verify form validates (try submitting empty form — should show errors). Verify file upload preview shows after selecting an image. Verify payment instructions display from Convex data (or empty state if none configured).</verify>
  <done>Checkout drawer opens with form fields (name, email, phone, screenshot upload). Payment instructions display from Convex. File upload shows preview. Form validates with Zod.</done>
</task>

<task type="auto">
  <name>Task 2: Wire checkout to pricing cards and create confirmation page</name>
  <files>
    apps/marketing/src/app/[locale]/page.tsx
    apps/marketing/src/app/[locale]/confirmation/page.tsx
    apps/marketing/src/components/sections/pricing.tsx
    apps/marketing/src/messages/en.json
    apps/marketing/src/messages/ar.json
  </files>
  <action>
**Update pricing section (`pricing.tsx`):**
- Add state for selected plan and drawer open/close
- When "Choose Plan" button is clicked, set selected plan and open drawer
- Render `<CheckoutDrawer>` at the bottom of the pricing section
- On successful submission (onSuccess callback), navigate to `/confirmation`

**Update landing page (`page.tsx`):**
- The pricing section now handles its own drawer state, so no changes needed to page.tsx except ensuring the import is correct

**Create confirmation page (`confirmation/page.tsx`):**
- Server component (or "use client" if needed for translations)
- Simple centered layout with:
  - Checkmark icon (lucide-react `CheckCircle2`)
  - Heading: "Signup Submitted Successfully!" / Arabic equivalent
  - Subheading: "Check your email to complete your account setup"
  - Explanation text: "We've sent you an email with a link to set your password. After setting up your account, your payment will be reviewed by the coach."
  - Expected timeline: "Approval typically takes 24-48 hours"
  - Link back to marketing home page
- Use royal blue accent for the checkmark icon
- Mobile-friendly centered card layout

**Update messages (en.json, ar.json):**
- Add checkout namespace: formTitle, fullName, email, phone, uploadScreenshot, dragDrop, tapUpload, submit, submitting, fileTooLarge, invalidFileType, paymentInstructions, noPaymentMethods
- Add confirmation namespace: title, subtitle, explanation, timeline, backToHome
- Full Arabic translations
  </action>
  <verify>Run marketing app end-to-end: view landing page → click "Choose Plan" on a pricing card → drawer opens with checkout form → fill in form + upload image → submit → redirects to confirmation page. Verify confirmation page shows correct messaging. Test in both EN and AR.</verify>
  <done>Checkout flow works end-to-end: pricing card CTA → drawer → form submission → confirmation page. All text is bilingual. File upload stores to Convex storage. createSignup mutation is called with all data.</done>
</task>

</tasks>

<verification>
1. Clicking "Choose Plan" on pricing card opens checkout drawer
2. Form validates all fields (name, email, phone required; email must be valid)
3. Payment instructions display from Convex (or empty state)
4. File upload accepts images, shows preview, rejects files > 5MB
5. Form submission calls createSignup with all data including storageId
6. Confirmation page renders after successful submission
7. Everything works in both EN and AR
</verification>

<success_criteria>
- Complete prospect funnel: view pricing → choose plan → fill form → upload payment → submit → see confirmation
- Payment screenshot is stored in Convex storage
- Signup record is created in Convex with all data
- Convex backend (plan 01) takes over from here (sends invitation email)
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-05-SUMMARY.md`
</output>
