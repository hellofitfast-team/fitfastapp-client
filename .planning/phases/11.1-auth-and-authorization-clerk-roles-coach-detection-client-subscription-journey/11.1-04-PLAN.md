---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
plan: 04
type: execute
wave: 2
depends_on: ["11.1-01"]
files_modified:
  - apps/admin/src/middleware.ts
  - apps/admin/src/types/globals.d.ts
  - apps/client/src/app/[locale]/(auth)/accept-invite/page.tsx
  - apps/client/src/app/[locale]/(onboarding)/pending/page.tsx
  - apps/client/src/app/globals.css
  - apps/client/src/components/providers/convex-provider.tsx
autonomous: true
requirements:
  - CLERK-ROLES
  - COACH-DETECTION
  - ACCEPT-INVITE
  - PENDING-REALTIME

must_haves:
  truths:
    - "Admin middleware checks sessionClaims.metadata.role === 'coach' via JWT (no DB query)"
    - "Accept-invite page uses useSignUp with ticket strategy to create Clerk accounts from invitation links"
    - "Pending page auto-redirects to initial-assessment when profile.status becomes 'active' (no manual button)"
    - "Pending page shows stepper: Signup Complete -> Under Review -> Approval Notification"
    - "ClerkProvider has cssLayerName: 'clerk' and globals.css has @layer declaration for Tailwind v4 compatibility"
  artifacts:
    - path: "apps/admin/src/middleware.ts"
      provides: "Admin middleware with Clerk role check"
      contains: "metadata?.role"
    - path: "apps/client/src/app/[locale]/(auth)/accept-invite/page.tsx"
      provides: "Accept invitation page using Clerk ticket strategy"
      contains: "strategy.*ticket"
    - path: "apps/client/src/app/[locale]/(onboarding)/pending/page.tsx"
      provides: "Pending approval page with Convex real-time subscription"
      contains: "useQuery"
  key_links:
    - from: "apps/admin/src/middleware.ts"
      to: "Clerk JWT"
      via: "sessionClaims?.metadata?.role check"
      pattern: "role.*coach"
    - from: "apps/client/src/app/[locale]/(auth)/accept-invite/page.tsx"
      to: "Clerk signUp"
      via: "signUp.create({ strategy: 'ticket', ticket: token })"
      pattern: "strategy.*ticket"
    - from: "apps/client/src/app/[locale]/(onboarding)/pending/page.tsx"
      to: "convex/profiles.ts"
      via: "useQuery(api.profiles.getMyProfile)"
      pattern: "getMyProfile"
---

<objective>
Fix admin coach detection to use Clerk JWT roles, create the accept-invite page for Clerk invitation flow, and update the pending page for real-time auto-redirect. Also fix Tailwind v4 + Clerk CSS layer conflict.

Purpose: These are the client and admin app changes needed for the new signup flow. The admin must correctly identify coach users. New clients must be able to accept invitations and see their approval status in real-time.
Output: Working admin RBAC via Clerk roles, functional accept-invite page, and real-time pending page.
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-RESEARCH.md
@.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-01-SUMMARY.md
@apps/admin/src/middleware.ts
@apps/client/src/middleware.ts
@apps/client/src/app/[locale]/(onboarding)/pending/page.tsx
@apps/client/src/components/providers/convex-provider.tsx
@apps/client/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix admin RBAC middleware and Clerk CSS layer compatibility</name>
  <files>
    apps/admin/src/middleware.ts
    apps/admin/src/types/globals.d.ts
    apps/client/src/app/globals.css
    apps/client/src/components/providers/convex-provider.tsx
  </files>
  <action>
**Update `apps/admin/src/middleware.ts`:**
- Currently the admin middleware checks auth but doesn't verify coach role (relies on layout check against Convex `isCoach`)
- Add Clerk JWT role check AFTER the userId check:
  ```typescript
  const { userId, sessionClaims } = await auth();
  // ... existing redirect if !userId ...

  // Gate admin on Clerk role — fast JWT check, no DB query
  const role = (sessionClaims as CustomJwtSessionClaims)?.metadata?.role;
  if (role !== "coach") {
    return NextResponse.redirect(new URL(`/${locale}/login?error=not_coach`, request.nextUrl.origin));
  }
  ```
- Keep the existing layout-level `profile.isCoach` check as defense-in-depth (don't remove it)
- Import the `CustomJwtSessionClaims` type

**Create `apps/admin/src/types/globals.d.ts`:**
```typescript
export {};
declare global {
  interface CustomJwtSessionClaims {
    metadata: { role?: "coach" | "client" };
  }
}
```

**Update `apps/client/src/app/globals.css`:**
- Add CSS layer declaration at the very top (BEFORE `@import "tailwindcss"`):
  ```css
  @layer theme, base, clerk, components, utilities;
  ```
- This prevents Clerk's injected styles from overriding Tailwind utilities

**Update `apps/client/src/components/providers/convex-provider.tsx`:**
- Add `appearance={{ cssLayerName: 'clerk' }}` prop to the `ClerkProvider` component
- This scopes Clerk's CSS to the `clerk` layer, working with the @layer declaration above
  </action>
  <verify>Run admin app. Attempt to access admin panel with a non-coach user — should redirect to `/login?error=not_coach`. Access with coach user — should pass through. Run client app — verify no visual regressions from the CSS layer change (Clerk components should look the same, Tailwind utilities should still override correctly).</verify>
  <done>Admin middleware gates on Clerk publicMetadata.role === "coach". ClerkProvider has cssLayerName for Tailwind v4 compatibility. globals.css has @layer declaration.</done>
</task>

<task type="auto">
  <name>Task 2: Create accept-invite page and update pending page</name>
  <files>
    apps/client/src/app/[locale]/(auth)/accept-invite/page.tsx
    apps/client/src/app/[locale]/(onboarding)/pending/page.tsx
  </files>
  <action>
**Create `apps/client/src/app/[locale]/(auth)/accept-invite/page.tsx`:**
- "use client" component
- Uses `useSignUp` and `useUser` from `@clerk/nextjs`
- Uses `useSearchParams` to get `__clerk_ticket` query param
- Uses `useRouter` from `next/navigation`
- Uses `useTranslations("auth")` for i18n

**Logic:**
1. If `isSignedIn` is true, `router.replace("/pending")` (already completed signup)
2. If no `__clerk_ticket` param, show "Invalid invitation link" message with link to login
3. Show a clean form with:
   - Heading: "Welcome to FitFast" / "مرحباً بك في فيت فاست"
   - Subheading: "Set your password to complete signup"
   - Password input field
   - Confirm password input field
   - Submit button: "Create Account"
   - `<div id="clerk-captcha" />` for bot protection (required by Clerk)
4. On submit:
   - Validate passwords match
   - Call `signUp.create({ strategy: "ticket", ticket: token, password })`
   - If `result.status === "complete"`, call `setActive({ session: result.createdSessionId })`
   - The `isSignedIn` useEffect then redirects to `/pending`
5. Handle errors gracefully — show error message if ticket is invalid/expired

**Styling:** Use same auth page layout as existing login page (centered card, royal blue accents). Import `Button`, `Input`, `Label` from `@fitfast/ui`.

**Update `apps/client/src/app/[locale]/(onboarding)/pending/page.tsx`:**
- Keep existing stepper UI pattern but update the steps:
  1. "Signup Complete" (always checked/green)
  2. "Under Review" (current active step while `profile.status === "pending_approval"`)
  3. "Approval Notification" (pending, becomes active on approval)
- Remove the "Check Status" button entirely — trust Convex real-time subscription
- Remove any manual refresh/polling logic
- Add `useEffect` that watches `profile?.status`:
  - If `"active"` → `router.replace("/initial-assessment")` (auto-redirect on approval)
  - If `"inactive"` or `"expired"` → `router.replace("/login?error=rejected")` (rejected)
- Add messaging: "Approval typically takes 24-48 hours" at bottom
- Show the user's email and plan they selected (from profile or from the pending signup record)
- Keep the existing visual design (stepper with icons, current status badge)

**Add i18n strings:**
- Add to `apps/client/src/messages/en.json` under `"auth"` namespace: `acceptInvite`, `setPassword`, `confirmPassword`, `createAccount`, `invalidInviteLink`, `inviteExpired`, `passwordsMustMatch`
- Add to `apps/client/src/messages/ar.json` the Arabic equivalents
- Update pending page strings: remove "checkStatus", add "approvalTime" message
  </action>
  <verify>Run client app. Navigate to `/en/accept-invite` without a token — should show "Invalid invitation link". Navigate with a fake `__clerk_ticket` param — should show the password form (will error on submit with invalid ticket). Check pending page renders with updated stepper and no "Check Status" button.</verify>
  <done>Accept-invite page handles Clerk invitation ticket, shows password form, creates account on submit, and redirects to pending. Pending page auto-redirects on approval via Convex real-time subscription, shows updated stepper without manual refresh button.</done>
</task>

</tasks>

<verification>
1. Admin middleware rejects non-coach users with redirect to login
2. Accept-invite page renders password form when `__clerk_ticket` is present
3. Pending page shows 3-step stepper without "Check Status" button
4. No CSS regressions from Clerk layer changes
5. All new strings exist in both en.json and ar.json
</verification>

<success_criteria>
- Coach users access admin panel; non-coach users are rejected at middleware level
- New prospects can accept Clerk invitations and set their passwords
- Pending approval page updates in real-time when coach approves/rejects
- Tailwind v4 + Clerk CSS compatibility is resolved
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey/11.1-04-SUMMARY.md`
</output>
