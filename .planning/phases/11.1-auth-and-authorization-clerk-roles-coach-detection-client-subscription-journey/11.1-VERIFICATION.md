---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
verified: 2026-02-21T00:00:00Z
status: passed
score: 7/7 must-haves verified
re_verification: null
gaps: []
human_verification:
  - test: "Accept-invite page with real Clerk ticket"
    expected: "Visiting /en/accept-invite?__clerk_ticket=<valid_token> shows password form, setting password creates account, auto-redirects to /pending"
    why_human: "Requires a live Clerk invitation token — cannot be verified without a real Clerk deployment and active invitation"
  - test: "Real-time pending page auto-redirect on approval"
    expected: "When coach approves a signup in admin, the pending page on client redirects to /initial-assessment within seconds (Convex real-time push)"
    why_human: "Requires two live browser sessions and a running Convex deployment — cannot be verified statically"
  - test: "Arabic RTL visual layout across all three apps"
    expected: "Switching to /ar on marketing, client, and admin shows correct right-to-left layout with Arabic text, mirrored UI elements"
    why_human: "Visual layout verification requires a browser — cannot be determined from code alone"
  - test: "Clerk invitation email delivery on approval"
    expected: "After coach clicks Approve in admin, the prospect receives a Clerk-branded invitation email with accept link"
    why_human: "Requires live Clerk deployment with CLERK_SECRET_KEY configured and a real email address"
---

# Phase 11.1: Auth and Authorization / Clerk Roles / Client Subscription Journey — Verification Report

**Phase Goal:** The full client acquisition circle works end-to-end: prospect lands on marketing site → picks a plan → submits payment screenshot (InstaPay/Vodafone Cash) → receives credentials via email → awaits coach approval → logs in → completes initial assessment. Coach users are properly identified via Clerk roles and can access the admin panel. Client users are gated by approval status and plan tier.

**Verified:** 2026-02-21T00:00:00Z
**Status:** passed
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Full acquisition circle works: marketing site → checkout → invitation email → accept invite → pending → approval → initial assessment | VERIFIED | All artifacts exist and are wired: marketing pricing → checkout drawer → createSignup mutation → admin approveSignup → clerkActions.sendInvitation → accept-invite page (strategy: ticket) → pending page (useEffect watches profile.status → redirect to /initial-assessment) |
| 2 | Admin can configure plans and payment methods that appear on marketing site | VERIFIED | PlansManager and PaymentMethodsManager exist in admin settings, both use updatePlans/updatePaymentMethods mutations to systemConfig; marketing Pricing component reads via getPlans, PaymentInstructions reads via getPaymentMethods |
| 3 | Admin can approve/reject signups with proper Clerk integration | VERIFIED | approveSignup schedules clerkActions.sendInvitation via ctx.scheduler.runAfter; rejectSignup schedules deleteUserAndInvitation and sendRejectionEmail; rejection requires rejectionReason input (enforced in both signups-table.tsx and [id]/page.tsx) |
| 4 | Both English and Arabic layouts work correctly across all three apps | VERIFIED (automated) + HUMAN NEEDED (visual) | All three apps have en.json + ar.json with matching keys; marketing layout.tsx sets html dir="rtl" for locale=ar; client globals.css has @layer theme, base, clerk, components, utilities; admin and client both support next-intl with routing; language-switcher component exists in marketing |
| 5 | Admin middleware checks Clerk role — blocks non-coach users | VERIFIED | admin middleware.ts checks sessionClaims?.metadata?.role, falls back to clerkClient API, redirects to /${locale}/login?error=not_coach if role !== "coach" |
| 6 | Checkout drawer opens from pricing card, form submits to Convex with file upload | VERIFIED | pricing.tsx calls handleSelectPlan → setSelectedPlan + setDrawerOpen; CheckoutDrawer renders CheckoutForm; CheckoutForm calls fetch to NEXT_PUBLIC_CONVEX_SITE_URL/marketing/upload-url then useMutation(api.pendingSignups.createSignup) |
| 7 | Pending page auto-redirects on approval — no manual button | VERIFIED | pending/page.tsx useEffect watches profile.status; if "active" → router.replace("/initial-assessment"); if "inactive"/"expired" → router.replace("/login?error=rejected"); no "Check Status" button present |

**Score:** 7/7 truths verified

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `convex/clerkActions.ts` | Clerk Backend API integration (sendInvitation, deleteUserAndInvitation) | VERIFIED | Exists, substantive, starts with "use node"; exports both sendInvitation and deleteUserAndInvitation as internalAction with explicit Promise<void> return types |
| `convex/schema.ts` | pendingSignups table with rejectionReason and clerkInvitationId | VERIFIED | Both fields present: rejectionReason: v.optional(v.string()), clerkInvitationId: v.optional(v.string()) |
| `convex/http.ts` | Public upload URL endpoint at /marketing/upload-url | VERIFIED | POST and OPTIONS routes at /marketing/upload-url with CORS headers; handler calls ctx.storage.generateUploadUrl() |
| `convex/pendingSignups.ts` | approveSignup triggers Clerk invite; rejectSignup stores reason and schedules cleanup | VERIFIED | approveSignup calls ctx.scheduler.runAfter(0, internal.clerkActions.sendInvitation, ...); rejectSignup patches with rejectionReason and schedules both deleteUserAndInvitation and sendRejectionEmail |
| `convex/systemConfig.ts` | getPlans, updatePlans, getPaymentMethods, updatePaymentMethods | VERIFIED | All four functions exist with correct public (no auth) queries and coach-gated mutations |
| `apps/marketing/package.json` | @fitfast/marketing package | VERIFIED | name: "@fitfast/marketing", dev script runs on port 3002 |
| `apps/marketing/middleware.ts` | next-intl only (no Clerk) | VERIFIED | Uses createMiddleware(routing) only — no clerkMiddleware import |
| `apps/marketing/src/app/[locale]/layout.tsx` | Locale layout with Convex + NextIntl providers, html dir attribute | VERIFIED | Sets html lang={locale} dir={dir} where dir = locale === "ar" ? "rtl" : "ltr"; wraps with ConvexClientProvider and NextIntlClientProvider |
| `apps/marketing/src/components/sections/pricing.tsx` | Pricing cards reading from Convex getPlans | VERIFIED | useQuery(api.systemConfig.getPlans), handles loading/empty states, wires onSelectPlan → CheckoutDrawer |
| `apps/marketing/src/components/checkout/checkout-drawer.tsx` | Vaul drawer wrapping checkout form | VERIFIED | Uses Drawer from @fitfast/ui/drawer, renders CheckoutForm |
| `apps/marketing/src/components/checkout/checkout-form.tsx` | Form with file upload, Zod validation, createSignup mutation | VERIFIED | useForm with zodResolver, useMutation(api.pendingSignups.createSignup), fetch to NEXT_PUBLIC_CONVEX_SITE_URL/marketing/upload-url, image preview, 5MB limit |
| `apps/marketing/src/components/checkout/payment-instructions.tsx` | Payment methods from Convex | VERIFIED | useQuery(api.systemConfig.getPaymentMethods), renders method list or empty state |
| `apps/marketing/src/app/[locale]/confirmation/page.tsx` | Post-submission confirmation page | VERIFIED | Exists with CheckCircle2 icon, confirmation text, timeline, link back to home |
| `apps/admin/src/middleware.ts` | Role check on Clerk JWT with API fallback | VERIFIED | Checks sessionClaims?.metadata?.role, falls back to clerkClient().users.getUser(userId), redirects with error=not_coach if role !== "coach" |
| `apps/admin/src/types/globals.d.ts` | CustomJwtSessionClaims type declaration | VERIFIED | Declares global interface CustomJwtSessionClaims with metadata.role |
| `apps/client/src/app/[locale]/(auth)/accept-invite/page.tsx` | Accept invitation page with Clerk ticket strategy | VERIFIED | Uses useSignUp, calls signUp.create({ strategy: "ticket", ticket: token, password }); handles invalid/missing token; redirects to /pending on success |
| `apps/client/src/app/[locale]/(onboarding)/pending/page.tsx` | Pending page with real-time auto-redirect, 3-step stepper | VERIFIED | 3-step stepper (Signup Complete, Under Review, Approval Notification); useEffect auto-redirects on profile.status === "active"; no manual "Check Status" button |
| `apps/client/src/app/globals.css` | @layer declaration for Tailwind v4 + Clerk compatibility | VERIFIED | First line (after comment): @layer theme, base, clerk, components, utilities; |
| `apps/client/src/components/providers/convex-provider.tsx` | ClerkProvider with cssLayerName: "clerk" | VERIFIED | appearance={{ cssLayerName: "clerk" }} present on ClerkProvider |
| `apps/admin/src/app/[locale]/(panel)/signups/[id]/page.tsx` | Signup detail with payment screenshot and rejection reason input | VERIFIED | useQuery(api.pendingSignups.getSignupById); useQuery(api.storage.getFileUrl) for screenshot; approve/reject buttons; rejection requires textarea input before submitting |
| `apps/admin/src/app/[locale]/(panel)/settings/plans-manager.tsx` | Plans CRUD with bilingual fields, max 4, updatePlans mutation | VERIFIED | useMutation(api.systemConfig.updatePlans); max 4 enforced; EN+AR name, duration, features, badge fields; validate before save |
| `apps/admin/src/app/[locale]/(panel)/settings/payment-methods-manager.tsx` | Payment methods CRUD with updatePaymentMethods mutation | VERIFIED | useMutation(api.systemConfig.updatePaymentMethods); add/remove methods; type, accountName, accountNumber, instructions fields |
| `apps/admin/src/app/[locale]/(panel)/settings/settings-form.tsx` | Settings page renders PlansManager and PaymentMethodsManager | VERIFIED | Imports and renders both PlansManager and PaymentMethodsManager in their own sections |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `convex/pendingSignups.ts:approveSignup` | `convex/clerkActions.ts:sendInvitation` | `ctx.scheduler.runAfter(0, internal.clerkActions.sendInvitation, ...)` | WIRED | Line 102 in pendingSignups.ts confirms the call with email, fullName, signupId |
| `convex/clerkActions.ts:sendInvitation` | `@clerk/backend createInvitation` | `clerkClient.invitations.createInvitation(...)` | WIRED | Line 28 in clerkActions.ts |
| `convex/pendingSignups.ts:rejectSignup` | `convex/clerkActions.ts:deleteUserAndInvitation` | `ctx.scheduler.runAfter(0, internal.clerkActions.deleteUserAndInvitation, ...)` | WIRED | Lines 137-139 in pendingSignups.ts |
| `convex/pendingSignups.ts:rejectSignup` | `convex/email.ts:sendRejectionEmail` | `ctx.scheduler.runAfter(0, internal.email.sendRejectionEmail, ...)` | WIRED | Lines 143-148 in pendingSignups.ts |
| `apps/marketing/pricing.tsx` | `convex/systemConfig.ts:getPlans` | `useQuery(api.systemConfig.getPlans)` | WIRED | Line 42 in pricing.tsx |
| `apps/marketing/checkout-form.tsx` | `convex/pendingSignups.ts:createSignup` | `useMutation(api.pendingSignups.createSignup)` | WIRED | Line 42 in checkout-form.tsx, called at line 150 on submit |
| `apps/marketing/checkout-form.tsx` | `convex/http.ts:/marketing/upload-url` | `fetch(${convexSiteUrl}/marketing/upload-url, { method: "POST" })` | WIRED | Lines 122-130 in checkout-form.tsx |
| `apps/marketing/payment-instructions.tsx` | `convex/systemConfig.ts:getPaymentMethods` | `useQuery(api.systemConfig.getPaymentMethods)` | WIRED | Line 11 in payment-instructions.tsx |
| `apps/admin/signups/[id]/page.tsx` | `convex/pendingSignups.ts:getSignupById` | `useQuery(api.pendingSignups.getSignupById, { signupId })` | WIRED | Line 51 in [id]/page.tsx |
| `apps/admin/signups/signups-table.tsx` | `convex/pendingSignups.ts:rejectSignup` | `useMutation(api.pendingSignups.rejectSignup)` called with `{ signupId, rejectionReason }` | WIRED | Line 90 in signups-table.tsx |
| `apps/admin/settings/plans-manager.tsx` | `convex/systemConfig.ts:updatePlans` | `useMutation(api.systemConfig.updatePlans)` | WIRED | Line 48 in plans-manager.tsx, called at line 178 |
| `apps/admin/settings/payment-methods-manager.tsx` | `convex/systemConfig.ts:updatePaymentMethods` | `useMutation(api.systemConfig.updatePaymentMethods)` | WIRED | Line 39 in payment-methods-manager.tsx, called at line 97 |
| `apps/admin/middleware.ts` | `Clerk JWT role` | `sessionClaims?.metadata?.role` then fallback to `clerkClient().users.getUser(userId)` | WIRED | Lines 47-56 in admin middleware.ts |
| `apps/client/accept-invite/page.tsx` | `Clerk signUp` | `signUp.create({ strategy: "ticket", ticket: token, password })` | WIRED | Lines 51-55 in accept-invite page.tsx |
| `apps/client/pending/page.tsx` | `convex/profiles.ts` | `useAuth hook → profile.status watched in useEffect` | WIRED | Lines 17-28 in pending/page.tsx; useAuth hook uses useQuery(api.profiles.getMyProfile) |

---

### Requirements Coverage

| Requirement ID | Source Plan | Description | Status | Evidence |
|----------------|-------------|-------------|--------|----------|
| CLERK-ROLES | 11.1-01, 11.1-04 | Clerk JWT role metadata for coach detection | SATISFIED | admin middleware checks sessionClaims?.metadata?.role; CustomJwtSessionClaims declared in globals.d.ts |
| COACH-DETECTION | 11.1-04 | Admin panel gates on Clerk role, not DB query | SATISFIED | Role check in middleware (JWT first, API fallback) — no DB round-trip required for fast checks |
| ACCEPT-INVITE | 11.1-04 | Accept invitation page using Clerk ticket strategy | SATISFIED | accept-invite/page.tsx implements signUp.create({ strategy: "ticket", ticket, password }) |
| PENDING-REALTIME | 11.1-04 | Pending page auto-redirects when profile becomes active | SATISFIED | useEffect watches profile.status and calls router.replace without any "Check Status" button |
| MARKETING-LANDING | 11.1-02, 11.1-03 | Marketing site scaffold with landing page content | SATISFIED | Full page with Hero, Features, Pricing, Testimonials, Footer; runs on port 3002 |
| CHECKOUT-FLOW | 11.1-05 | Checkout drawer, form, file upload, createSignup | SATISFIED | checkout-drawer.tsx → checkout-form.tsx → fetch /marketing/upload-url → createSignup mutation |
| ADMIN-SIGNUPS | 11.1-06 | Admin signup detail view with payment screenshot | SATISFIED | [id]/page.tsx shows signup info, payment screenshot (via api.storage.getFileUrl), OCR data, approve/reject actions |
| PLANS-CONFIG | 11.1-01, 11.1-06 | Coach-configurable pricing plans stored in systemConfig | SATISFIED | getPlans/updatePlans in systemConfig.ts; PlansManager in admin settings |
| PAYMENT-METHODS | 11.1-01, 11.1-06 | Coach-configurable payment methods for checkout | SATISFIED | getPaymentMethods/updatePaymentMethods in systemConfig.ts; PaymentMethodsManager in admin settings; PaymentInstructions in checkout |
| END-TO-END-FLOW | 11.1-07 | Full acquisition circle verified end-to-end | SATISFIED | SUMMARY-07 documents manual E2E verification completing all 7 test scenarios; 6 bugs found and fixed (commit c144c87) |
| SIGNUP-FLOW | 11.1-01 | createSignup mutation with planId | SATISFIED | createSignup in pendingSignups.ts accepts planId: v.optional(v.string()) |
| APPROVAL-FLOW | 11.1-01 | approveSignup schedules Clerk invitation | SATISFIED | approveSignup calls ctx.scheduler.runAfter(0, internal.clerkActions.sendInvitation, ...) |
| REJECTION-FLOW | 11.1-01 | rejectSignup with reason, Clerk cleanup, rejection email | SATISFIED | rejectSignup patches status with rejectionReason, schedules deleteUserAndInvitation and sendRejectionEmail |
| MARKETING-SCAFFOLD | 11.1-02 | Marketing app as 3rd monorepo member with i18n | SATISFIED | apps/marketing/ with correct package.json, next.config.ts, middleware.ts (next-intl only), i18n routing |
| MARKETING-BILINGUAL | 11.1-02, 11.1-03 | EN+AR with RTL layout on marketing site | SATISFIED | layout.tsx sets dir="rtl" for ar; en.json and ar.json present; language-switcher.tsx |
| MARKETING-HERO | 11.1-03 | Hero section with CTA | SATISFIED | hero.tsx with sticky header, headline, CTA button scrolling to #pricing |
| MARKETING-FEATURES | 11.1-03 | Features section | SATISFIED | features.tsx with 3-card grid |
| MARKETING-PRICING | 11.1-03 | Pricing cards from Convex | SATISFIED | pricing.tsx reads getPlans, handles loading/empty states, opens checkout drawer on plan select |
| MARKETING-TRUST | 11.1-03 | Trust signals / testimonials section | SATISFIED | testimonials.tsx with metric cards |
| CHECKOUT-DRAWER | 11.1-05 | Vaul drawer for checkout | SATISFIED | checkout-drawer.tsx uses Drawer from @fitfast/ui/drawer |
| CHECKOUT-FORM | 11.1-05 | Form fields with Zod validation | SATISFIED | react-hook-form + zodResolver; name, email, phone fields validated |
| PAYMENT-UPLOAD | 11.1-05 | Screenshot upload to Convex storage | SATISFIED | Fetch to /marketing/upload-url, PUT to uploadUrl, storageId passed to createSignup |
| CONFIRMATION-PAGE | 11.1-05 | Post-submission confirmation | SATISFIED | confirmation/page.tsx with CheckCircle2, check email message, timeline |
| ADMIN-SIGNUP-DETAIL | 11.1-06 | Signup detail with payment screenshot display | SATISFIED | signups/[id]/page.tsx with api.storage.getFileUrl query |
| ADMIN-REJECT-REASON | 11.1-06 | Rejection requires reason input | SATISFIED | Both signups-table.tsx and [id]/page.tsx enforce non-empty rejection reason before allowing submit |
| ADMIN-PLANS-CONFIG | 11.1-06 | Plans manager CRUD in admin settings | SATISFIED | plans-manager.tsx with full CRUD, max 4 plans enforced, bilingual fields |
| ADMIN-PAYMENT-METHODS | 11.1-06 | Payment methods manager in admin settings | SATISFIED | payment-methods-manager.tsx with add/remove/edit and ACCOUNT_TYPES select |

All 27 requirement IDs accounted for. No orphaned requirements.

---

### Anti-Patterns Found

None. Scanned checkout components, signups admin pages, convex/clerkActions.ts, and convex/pendingSignups.ts. Only occurrences of "placeholder" were HTML input placeholder attributes (correct usage). No TODO/FIXME/return null/stub handlers found in key phase files.

---

### Human Verification Required

#### 1. Accept-invite page with real Clerk ticket

**Test:** Get a real Clerk invitation link (by triggering an approval in admin), click the link, set a password, submit
**Expected:** Account is created, session is activated, page auto-redirects to /pending
**Why human:** Requires a live Clerk deployment with CLERK_SECRET_KEY configured and an actual invitation email

#### 2. Real-time pending page auto-redirect on approval

**Test:** With a client logged in on the pending page, have the coach approve their signup in admin
**Expected:** The pending page on the client browser redirects to /initial-assessment within seconds (no page refresh)
**Why human:** Requires two simultaneous browser sessions and a live Convex deployment

#### 3. Arabic RTL visual layout across all three apps

**Test:** On each app (ports 3000, 3001, 3002), switch to Arabic locale (/ar path)
**Expected:** UI mirrors to right-to-left: text aligns right, flex rows reverse, form labels on right side, navigation flips
**Why human:** Visual layout verification requires a browser — RTL correctness cannot be asserted from code alone

#### 4. Clerk invitation email delivery on approval

**Test:** Submit a checkout form on marketing with a real email, have coach approve in admin
**Expected:** Prospect receives Clerk-branded email with "Accept invitation" link pointing to /en/accept-invite?__clerk_ticket=...
**Why human:** Requires live Clerk deployment, real CLERK_SECRET_KEY, and an email inbox to verify receipt

---

## Gaps Summary

No gaps found. All seven observable truths are verified through artifact existence, substantive implementation, and wiring. The acquisition circle is fully connected in code:

- **Marketing → Convex:** Pricing reads getPlans, checkout submits createSignup with screenshot storageId
- **Convex → Clerk:** approveSignup schedules sendInvitation via clerkActions.ts
- **Clerk → Client:** accept-invite page handles __clerk_ticket strategy
- **Client → Convex real-time:** pending page watches profile.status reactively
- **Admin → Convex:** signups table and detail page wire approve/reject mutations
- **Admin → Marketing:** plans and payment methods managers write to systemConfig read by marketing

Four items require human/live-environment verification (Clerk email delivery, RTL visual layout, real ticket flow, real-time redirect) — these are inherently unverifiable from static code analysis.

---

_Verified: 2026-02-21T00:00:00Z_
_Verifier: Claude (gsd-verifier)_
