---
phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey
plan: 01
subsystem: auth
tags: [clerk, convex, invitation-flow, email, http-actions, pricing-plans, payment-methods]

# Dependency graph
requires: []
provides:
  - "Convex clerkActions.ts with sendInvitation and deleteUserAndInvitation internalActions"
  - "pendingSignups schema with rejectionReason, clerkInvitationId, planId fields"
  - "approveSignup mutation triggers Clerk invitation (replaces welcome email)"
  - "rejectSignup mutation with rejectionReason, schedules Clerk cleanup and rejection email"
  - "patchInvitationId internalMutation for storing Clerk invitation ID back on signup record"
  - "getSignupById query for admin signup detail view"
  - "sendRejectionEmail internalAction with bilingual template"
  - "Public POST /marketing/upload-url HTTP endpoint for unauthenticated payment screenshot upload"
  - "getPlans public query returning coach-configurable pricing plan data"
  - "updatePlans coach-only mutation for pricing plan management"
  - "getPaymentMethods public query for checkout form (InstaPay, Vodafone Cash, etc.)"
  - "updatePaymentMethods coach-only mutation"
  - "@clerk/backend added to root dependencies for Convex Node.js actions"
affects:
  - marketing-app
  - admin-signups-ui
  - client-accept-invite
  - client-pending-page
  - admin-settings-payment-methods

# Tech tracking
tech-stack:
  added:
    - "@clerk/backend 2.32.0 — Clerk Backend API for invitation and user management in Convex actions"
  patterns:
    - "Convex mutation schedules internalAction for Clerk API calls (mutations run in V8, actions run in Node.js)"
    - "sendInvitation stores invitation ID back on signup record via patchInvitationId for later revocation"
    - "rejectSignup is a mutation that schedules cleanup actions (clerkActions.deleteUserAndInvitation + email.sendRejectionEmail)"
    - "Public Convex HTTP action for unauthenticated file upload URL generation (marketing checkout)"
    - "systemConfig table stores all coach-configurable data (plans, paymentMethods, pricing) as JSON blobs"

key-files:
  created:
    - "convex/clerkActions.ts — sendInvitation and deleteUserAndInvitation Node.js internalActions"
  modified:
    - "convex/schema.ts — pendingSignups table: added rejectionReason, clerkInvitationId, planId"
    - "convex/pendingSignups.ts — approveSignup/rejectSignup updated; patchInvitationId, getSignupById added"
    - "convex/email.ts — sendRejectionEmail internalAction added"
    - "convex/http.ts — /marketing/upload-url POST + OPTIONS endpoints added"
    - "convex/systemConfig.ts — getPlans, updatePlans, getPaymentMethods, updatePaymentMethods added"
    - "package.json — @clerk/backend added to root dependencies"

key-decisions:
  - "approveSignup schedules Clerk invitation via scheduler.runAfter (not mutation) — Clerk API requires Node.js runtime which mutations don't have"
  - "rejectSignup stays as mutation, schedules Clerk cleanup and rejection email as separate actions — avoids converting mutation to action which would break existing callers"
  - "sendInvitation stores clerkInvitationId back on signup record so rejection can revoke pending invitations"
  - "deleteUserAndInvitation handles case where Clerk user may not exist yet (coach rejects before prospect accepts invite)"
  - "@clerk/backend installed at root workspace level so Convex Node.js actions can import it"
  - "Marketing upload URL uses HTTP action (not public mutation) — cleaner security posture, scoped endpoint"

patterns-established:
  - "Pattern: Convex Node.js actions MUST be in files with 'use node' directive at top"
  - "Pattern: Dynamic imports (await import('@clerk/backend')) used in internalActions for runtime-specific packages"
  - "Pattern: Invitation ID stored on record for later revocation — always capture Clerk API response IDs"

requirements-completed: [CLERK-ROLES, SIGNUP-FLOW, APPROVAL-FLOW, REJECTION-FLOW, PLANS-CONFIG]

# Metrics
duration: 25min
completed: 2026-02-20
---

# Phase 11.1 Plan 01: Convex Backend Infrastructure for Clerk Invitation Flow Summary

**Convex backend wired for full signup-to-invite flow: Clerk invitation on approval, user deletion on rejection, public upload URL for marketing, and coach-configurable pricing plans/payment methods**

## Performance

- **Duration:** 25 min
- **Started:** 2026-02-20T00:00:00Z
- **Completed:** 2026-02-20T00:25:00Z
- **Tasks:** 2
- **Files modified:** 6 (1 created)

## Accomplishments

- Clerk invitation flow wired: `approveSignup` now schedules `clerkActions.sendInvitation` which calls Clerk Backend API to create an invitation with `redirectUrl` pointing to `/accept-invite` in client app
- Rejection flow complete: `rejectSignup` accepts a reason, stores it, schedules Clerk user deletion + invitation revocation, and sends a bilingual rejection email via Resend
- Marketing checkout enabled: Public `POST /marketing/upload-url` HTTP endpoint generates Convex storage upload URLs for unauthenticated prospects submitting payment screenshots
- Pricing plans and payment methods are now coach-configurable via `systemConfig` table with `getPlans`/`getPaymentMethods` public queries (no auth required for marketing page)

## Task Commits

Each task was committed atomically:

1. **Task 1: Update Convex schema and create Clerk actions module** - `129ccc7` (feat)
2. **Task 2: Update pendingSignups, email, HTTP upload, and plans config** - `387ae6b` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `convex/clerkActions.ts` — New file with `sendInvitation` and `deleteUserAndInvitation` internalActions using `"use node"` directive and `@clerk/backend` dynamic imports
- `convex/schema.ts` — `pendingSignups` table extended with `rejectionReason`, `clerkInvitationId`, `planId` optional fields
- `convex/pendingSignups.ts` — `approveSignup` sends Clerk invite, `rejectSignup` schedules cleanup, added `patchInvitationId` and `getSignupById`
- `convex/email.ts` — Added `getRejectionEmail` template function and `sendRejectionEmail` internalAction
- `convex/http.ts` — Added `/marketing/upload-url` POST + OPTIONS routes for unauthenticated upload URL generation
- `convex/systemConfig.ts` — Added `getPlans`, `updatePlans`, `getPaymentMethods`, `updatePaymentMethods`
- `package.json` — Added `@clerk/backend` to root workspace dependencies

## Decisions Made

- `approveSignup` stays as a mutation (fast, synchronous DB patch) and schedules the Clerk invitation as a background internalAction — this is the correct Convex pattern because Clerk API requires Node.js runtime which mutations don't have
- `rejectSignup` stays as a mutation for the same reason — DB patches first, then schedules async cleanup via `ctx.scheduler.runAfter`
- The `sendInvitation` action stores the returned `invitation.id` back on the signup record via `patchInvitationId` — this enables rejection to revoke pending invitations even before the prospect accepts
- `deleteUserAndInvitation` handles the timing gap: coach may reject before prospect accepts invite, so it checks `getUserList` before attempting deletion and wraps `revokeInvitation` in try/catch
- `@clerk/backend` added to root `package.json` (not just app-level) because Convex functions run from the root workspace context

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added @clerk/backend to root package.json**
- **Found during:** Task 1 (after running typecheck)
- **Issue:** Convex bundler could not resolve `@clerk/backend` — it's a peer dep of `@clerk/nextjs` installed in apps but not at root workspace level where Convex runs
- **Fix:** Ran `pnpm add @clerk/backend --workspace-root` to install at root
- **Files modified:** `package.json`, `pnpm-lock.yaml`
- **Verification:** `npx convex typecheck` no longer reports `@clerk/backend` resolution error
- **Committed in:** `387ae6b` (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking — missing dependency)
**Impact on plan:** Required fix; without it Convex actions would fail at runtime when importing Clerk Backend API.

## Issues Encountered

- TypeScript errors for `internal.clerkActions.*` in pendingSignups.ts — these are expected because the `_generated/api.d.ts` is built from the existing Convex deployment and doesn't yet include `clerkActions.ts`. These errors disappear after `npx convex dev` regenerates the types. All other TS checks pass clean.

## User Setup Required

Two Convex environment variables must be set before the invitation flow will work in any deployed environment:

```bash
npx convex env set CLERK_SECRET_KEY sk_...
npx convex env set CLIENT_APP_URL https://client.fitfast.app  # or http://localhost:3000 for dev
```

These are documented in the plan's `user_setup` section. Without them, `sendInvitation` and `deleteUserAndInvitation` will throw at runtime when calling `createClerkClient`.

## Next Phase Readiness

- Backend infrastructure complete — all frontend work (marketing checkout, admin approval UI, client accept-invite page) can now be built against these endpoints
- `createSignup` accepts `planId` for tracking which pricing plan the client selected at checkout
- `getPlans` and `getPaymentMethods` queries are public (no auth) — ready for marketing app
- `/marketing/upload-url` endpoint is live — ready for checkout form file upload

## Self-Check: PASSED

- FOUND: convex/clerkActions.ts
- FOUND: convex/schema.ts (with rejectionReason, clerkInvitationId)
- FOUND: convex/pendingSignups.ts
- FOUND: convex/email.ts
- FOUND: convex/http.ts (with /marketing/upload-url)
- FOUND: convex/systemConfig.ts (with getPlans, getPaymentMethods)
- FOUND: 11.1-01-SUMMARY.md
- FOUND commit: 129ccc7 (Task 1 — schema + clerkActions)
- FOUND commit: 387ae6b (Task 2 — pendingSignups, email, http, systemConfig)

---
*Phase: 11.1-auth-and-authorization-clerk-roles-coach-detection-client-subscription-journey*
*Completed: 2026-02-20*
