---
phase: 04-hardening-service-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/openrouter.ts
  - src/lib/ai/meal-plan-generator.ts
  - src/lib/ai/workout-plan-generator.ts
autonomous: true

must_haves:
  truths:
    - "OpenRouter API calls automatically retry on server/network errors (up to 3 attempts with 1s/2s/4s backoff)"
    - "OpenRouter API calls abort after 30 seconds if no response received"
    - "AI-generated meal plans are validated against Zod schema before returning"
    - "AI-generated workout plans are validated against Zod schema before returning"
    - "All JSON.parse calls in AI generators replaced by Zod validation helpers (which handle JSON parsing internally)"
    - "Service layer errors logged to Sentry with context (provider, userId, planDuration)"
  artifacts:
    - path: "src/lib/ai/openrouter.ts"
      provides: "OpenRouter client with retry, timeout, and AIGenerationError"
      contains: "withRetry"
    - path: "src/lib/ai/meal-plan-generator.ts"
      provides: "Meal plan generator using validateMealPlanResponse"
      contains: "validateMealPlanResponse"
    - path: "src/lib/ai/workout-plan-generator.ts"
      provides: "Workout plan generator using validateWorkoutPlanResponse"
      contains: "validateWorkoutPlanResponse"
  key_links:
    - from: "src/lib/ai/openrouter.ts"
      to: "@/lib/errors"
      via: "import withRetry, AIGenerationError"
      pattern: "import.*withRetry.*from.*@/lib/errors"
    - from: "src/lib/ai/meal-plan-generator.ts"
      to: "@/lib/validation"
      via: "import validateMealPlanResponse"
      pattern: "import.*validateMealPlanResponse.*from.*@/lib/validation"
    - from: "src/lib/ai/workout-plan-generator.ts"
      to: "@/lib/validation"
      via: "import validateWorkoutPlanResponse"
      pattern: "import.*validateWorkoutPlanResponse.*from.*@/lib/validation"
---

<objective>
Wrap OpenRouter API client with retry logic and 30-second timeout, then update both AI generators (meal plan, workout plan) to use Phase 3's Zod validation helpers instead of bare JSON.parse.

Purpose: This is the core reliability upgrade for the AI pipeline. Currently, a single network hiccup kills plan generation, and invalid AI JSON silently corrupts the database. After this plan, transient failures are retried automatically, invalid AI output is caught before DB save, and all errors are logged to Sentry with context.

Output: Three hardened files in src/lib/ai/ that use Phase 3 infrastructure (withRetry, AIGenerationError, validateMealPlanResponse, validateWorkoutPlanResponse).
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-hardening-service-layer/04-RESEARCH.md
@.planning/phases/03-hardening-foundation/03-01-SUMMARY.md
@.planning/phases/03-hardening-foundation/03-02-SUMMARY.md
@src/lib/ai/openrouter.ts
@src/lib/ai/meal-plan-generator.ts
@src/lib/ai/workout-plan-generator.ts
@src/lib/errors/types.ts
@src/lib/errors/retry.ts
@src/lib/validation/index.ts
@src/lib/validation/meal-plan.ts
@src/lib/validation/workout-plan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap OpenRouter client with retry and timeout</name>
  <files>src/lib/ai/openrouter.ts</files>
  <action>
  Modify the existing OpenRouterClient class to add retry logic and request timeouts:

  1. Add imports at top:
     - `import { withRetry, AIGenerationError } from "@/lib/errors";`
     - `import * as Sentry from "@sentry/nextjs";`

  2. In the `chat()` method, wrap the entire fetch+parse logic inside `withRetry()`:
     - `maxAttempts: 3`
     - `operationName: "openrouter-chat"`
     - `shouldRetry`: Return false for 4xx errors (400, 401, 403, 422) — these are client errors that retrying won't fix. Return true for 5xx and network errors.

  3. Inside the retry callback, add AbortController with 30-second timeout:
     ```typescript
     const controller = new AbortController();
     const timeoutId = setTimeout(() => controller.abort(), 30000);
     ```
     Pass `signal: controller.signal` to the fetch options. Clear timeout in finally block.

  4. Replace `throw new Error(...)` with `throw new AIGenerationError(...)`:
     - On non-OK response: `new AIGenerationError("OpenRouter API error: {status}", "openrouter", new Error(errorText))`
     - On empty choices: `new AIGenerationError("No response from OpenRouter", "openrouter")`
     - On abort/timeout: `new AIGenerationError("OpenRouter request timed out after 30s", "openrouter")`

  5. Keep all existing interfaces (OpenRouterMessage, OpenRouterResponse), the singleton pattern, and the `complete()` method exactly as they are. Only the `chat()` method internals change.

  IMPORTANT: The `complete()` method delegates to `chat()`, so it automatically inherits retry + timeout.
  </action>
  <verify>
  Run `pnpm tsc --noEmit 2>&1 | head -20` — zero new TypeScript errors related to openrouter.ts.
  Grep for `withRetry` in openrouter.ts to confirm retry wrapper is present.
  Grep for `AbortController` in openrouter.ts to confirm timeout is present.
  Grep for `AIGenerationError` in openrouter.ts to confirm proper error types.
  Confirm no bare `throw new Error(` remains in openrouter.ts.
  </verify>
  <done>
  OpenRouterClient.chat() retries up to 3 times with exponential backoff on server/network errors, aborts after 30 seconds, throws AIGenerationError (not generic Error), and the shouldRetry predicate skips 4xx client errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden meal plan generator with Zod validation and Sentry logging</name>
  <files>src/lib/ai/meal-plan-generator.ts</files>
  <action>
  Update generateMealPlan() to use Phase 3's validation helper and add Sentry error context:

  1. Add imports:
     - `import { validateMealPlanResponse, type ValidatedMealPlan } from "@/lib/validation";`
     - `import { AIGenerationError, ValidationError } from "@/lib/errors";`
     - `import * as Sentry from "@sentry/nextjs";`

  2. Change the return type from `Promise<GeneratedMealPlan>` to `Promise<ValidatedMealPlan>`.
     Keep the GeneratedMealPlan interface in the file (existing callers may reference it), but add a comment: `/** @deprecated Use ValidatedMealPlan from @/lib/validation instead */`

  3. Replace the manual JSON cleaning + JSON.parse block:
     ```typescript
     // OLD (remove this):
     const cleanedResponse = response.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
     const mealPlan: GeneratedMealPlan = JSON.parse(cleanedResponse);
     return mealPlan;
     ```
     With:
     ```typescript
     // NEW: Validate with Zod (handles JSON cleaning, parsing, and schema validation)
     const validatedPlan = validateMealPlanResponse(response);
     return validatedPlan;
     ```

  4. Replace the catch block — replace `console.error` with Sentry context logging:
     ```typescript
     catch (error) {
       Sentry.captureException(error, {
         tags: {
           feature: "meal-plan-generation",
           language,
         },
         extra: {
           userId: profile.id,
           planDuration,
           hasCheckIn: !!checkIn,
           action: "generate-meal-plan",
           timestamp: new Date().toISOString(),
         },
       });

       // Wrap ValidationError in AIGenerationError for consistent error type
       if (error instanceof ValidationError) {
         throw new AIGenerationError(
           `AI generated invalid meal plan: ${error.message}`,
           "openrouter",
           error
         );
       }

       // RetryError, AIGenerationError bubble up as-is
       throw error;
     }
     ```

  5. Keep the MealPlanGenerationParams interface and all system/user prompt logic unchanged.
  </action>
  <verify>
  Run `pnpm tsc --noEmit 2>&1 | head -20` — zero new errors from meal-plan-generator.ts.
  Grep for `validateMealPlanResponse` in meal-plan-generator.ts to confirm Zod validation is used.
  Grep for `JSON\.parse` in meal-plan-generator.ts — must return zero results (JSON.parse now happens inside validateMealPlanResponse).
  Grep for `console\.error` in meal-plan-generator.ts — must return zero results (replaced with Sentry).
  Grep for `Sentry.captureException` in meal-plan-generator.ts to confirm error logging.
  </verify>
  <done>
  Meal plan generator uses validateMealPlanResponse() for JSON parsing + Zod schema validation, logs errors to Sentry with userId/planDuration/language context, wraps ValidationError in AIGenerationError, and no bare JSON.parse or console.error remains.
  </done>
</task>

<task type="auto">
  <name>Task 3: Harden workout plan generator with Zod validation and Sentry logging</name>
  <files>src/lib/ai/workout-plan-generator.ts</files>
  <action>
  Apply the same hardening pattern as Task 2, but for the workout plan generator:

  1. Add imports:
     - `import { validateWorkoutPlanResponse, type ValidatedWorkoutPlan } from "@/lib/validation";`
     - `import { AIGenerationError, ValidationError } from "@/lib/errors";`
     - `import * as Sentry from "@sentry/nextjs";`

  2. Change the return type from `Promise<GeneratedWorkoutPlan>` to `Promise<ValidatedWorkoutPlan>`.
     Keep GeneratedWorkoutPlan interface with `/** @deprecated Use ValidatedWorkoutPlan from @/lib/validation instead */` comment.

  3. Replace the manual JSON cleaning + JSON.parse block:
     ```typescript
     // OLD (remove):
     const cleanedResponse = response.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
     const workoutPlan: GeneratedWorkoutPlan = JSON.parse(cleanedResponse);
     return workoutPlan;
     ```
     With:
     ```typescript
     // NEW: Validate with Zod (handles JSON cleaning, parsing, and schema validation)
     const validatedPlan = validateWorkoutPlanResponse(response);
     return validatedPlan;
     ```

  4. Replace catch block with Sentry logging (same pattern as Task 2 but with workout-specific tags):
     ```typescript
     catch (error) {
       Sentry.captureException(error, {
         tags: {
           feature: "workout-plan-generation",
           language,
         },
         extra: {
           userId: profile.id,
           planDuration,
           hasCheckIn: !!checkIn,
           action: "generate-workout-plan",
           timestamp: new Date().toISOString(),
         },
       });

       if (error instanceof ValidationError) {
         throw new AIGenerationError(
           `AI generated invalid workout plan: ${error.message}`,
           "openrouter",
           error
         );
       }

       throw error;
     }
     ```

  5. Keep WorkoutPlanGenerationParams and all prompt logic unchanged.
  </action>
  <verify>
  Run `pnpm tsc --noEmit 2>&1 | head -20` — zero new errors from workout-plan-generator.ts.
  Grep for `validateWorkoutPlanResponse` in workout-plan-generator.ts.
  Grep for `JSON\.parse` in workout-plan-generator.ts — must return zero results.
  Grep for `console\.error` in workout-plan-generator.ts — must return zero results.
  Grep for `Sentry.captureException` in workout-plan-generator.ts.
  </verify>
  <done>
  Workout plan generator uses validateWorkoutPlanResponse() for JSON parsing + Zod schema validation, logs errors to Sentry with userId/planDuration/language context, wraps ValidationError in AIGenerationError, and no bare JSON.parse or console.error remains.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with zero new errors in src/lib/ai/
2. No bare `JSON.parse` calls remain in src/lib/ai/meal-plan-generator.ts or src/lib/ai/workout-plan-generator.ts
3. No `console.error` remains in any of the three modified files
4. `withRetry` is used in openrouter.ts
5. `AbortController` timeout (30s) is present in openrouter.ts
6. `validateMealPlanResponse` imported and used in meal-plan-generator.ts
7. `validateWorkoutPlanResponse` imported and used in workout-plan-generator.ts
8. All three files import from `@/lib/errors` and/or `@sentry/nextjs`
</verification>

<success_criteria>
- OpenRouter API calls retry 3 times with exponential backoff (1s/2s/4s) on server/network errors
- OpenRouter API calls time out after 30 seconds
- 4xx client errors are NOT retried (shouldRetry returns false)
- AI meal plan responses validated through Zod before return
- AI workout plan responses validated through Zod before return
- No bare JSON.parse in AI generators (replaced by Zod validation helpers)
- All errors logged to Sentry with feature tag, userId, planDuration, language
- ValidationError wrapped in AIGenerationError for consistent error handling upstream
</success_criteria>

<output>
After completion, create `.planning/phases/04-hardening-service-layer/04-01-SUMMARY.md`
</output>
