---
phase: 05-hardening-api-routes
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/api/admin/ocr/route.ts
  - src/app/api/admin/approve-signup/route.ts
  - src/app/api/admin/notifications/send/route.ts
autonomous: true

must_haves:
  truths:
    - "OCR route validates request input (imageBase64/imageUrl/signupId) with Zod"
    - "OCR extracted data validated with Zod schema before database storage (ADMIN-02)"
    - "Approve-signup route validates signupId with Zod"
    - "Send notification route validates title/message/user_ids with Zod"
    - "All console.error and silent catch blocks replaced with Sentry logging"
  artifacts:
    - path: "src/app/api/admin/ocr/route.ts"
      provides: "OCR endpoint with input + output Zod validation and Sentry"
      contains: "OcrResultSchema"
    - path: "src/app/api/admin/approve-signup/route.ts"
      provides: "Signup approval with Zod validation and Sentry on notification failure"
      contains: "ApproveSignupSchema"
    - path: "src/app/api/admin/notifications/send/route.ts"
      provides: "Notification sending with Zod validation and Sentry"
      contains: "SendNotificationSchema"
  key_links:
    - from: "src/app/api/admin/ocr/route.ts"
      to: "src/lib/api-validation/admin.ts"
      via: "import OcrRequestSchema, OcrResultSchema"
      pattern: "import.*OcrResultSchema.*from.*api-validation"
    - from: "src/app/api/admin/approve-signup/route.ts"
      to: "src/lib/api-validation/admin.ts"
      via: "import ApproveSignupSchema"
      pattern: "import.*ApproveSignupSchema.*from.*api-validation"
---

<objective>
Apply Zod validation and Sentry error logging to all 3 admin API routes. This is the critical plan for ADMIN-02 (OCR output validation before database storage).

Purpose: Admin routes handle coach-only operations (OCR payment extraction, signup approval, notification sending). Input validation prevents corrupt data, OCR output validation (ADMIN-02) prevents invalid payment data from being saved to the database, and Sentry logging surfaces errors that were previously silent.
Output: 3 hardened admin API routes with comprehensive validation
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-hardening-api-routes/05-RESEARCH.md
@.planning/phases/05-hardening-api-routes/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden OCR route with input + output Zod validation (ADMIN-02)</name>
  <files>src/app/api/admin/ocr/route.ts</files>
  <action>
This is the key ADMIN-02 requirement. The OCR route needs TWO layers of validation: input validation (request body) and output validation (OCR AI response before database save).

- Import `{ validateRequestBody }` and `{ OcrRequestSchema, OcrResultSchema }` from `@/lib/api-validation`
- Import `* as Sentry` from `@sentry/nextjs`

**Input validation:**
- After `const body = await request.json()`, replace the manual `if (!imageBase64 && !imageUrl)` check with:
  ```typescript
  const validation = validateRequestBody(body, OcrRequestSchema, {
    userId: user.id,
    feature: "ocr-input",
  });
  if (!validation.success) return validation.response;
  const { imageBase64, imageUrl, signupId } = validation.data;
  ```

**OCR output validation (ADMIN-02):**
- After the JSON.parse of rawContent (where `ocrResult` is assigned), add Zod validation:
  ```typescript
  const ocrValidation = OcrResultSchema.safeParse(rawOcrResult);
  if (!ocrValidation.success) {
    Sentry.captureException(new Error("OCR validation failed"), {
      tags: { feature: "ocr-validation" },
      extra: {
        coachId: user.id,
        signupId,
        rawOcrResult,
        errors: ocrValidation.error.issues,
      },
    });
    return NextResponse.json(
      { error: "OCR extracted data is invalid", details: ocrValidation.error.issues, raw: rawOcrResult },
      { status: 422 }
    );
  }
  ```
- Use `ocrValidation.data` (instead of unvalidated `ocrResult`) for the database update and response

**Sentry replacement:**
- Replace `console.error("OpenRouter OCR error:", errorText)` with `Sentry.captureException(new Error("OpenRouter OCR API error"), { tags: { feature: "ocr-api" }, extra: { coachId: user.id, signupId, errorText } })`
- Replace `console.error("OCR extraction error:", err)` with `Sentry.captureException(err, { tags: { feature: "ocr-extraction" }, extra: { coachId: user.id, signupId } })`

Remove the old `OcrResult` TypeScript interface since the Zod schema now provides the type.
  </action>
  <verify>
`pnpm tsc --noEmit 2>&1 | grep -c "error TS"` returns 0 new errors.
`grep -c "console.error" src/app/api/admin/ocr/route.ts` returns 0.
`grep -c "OcrResultSchema" src/app/api/admin/ocr/route.ts` returns at least 1.
  </verify>
  <done>OCR route validates both input (imageBase64/imageUrl) and output (AI-extracted data) with Zod. Invalid OCR data is rejected before database save. All errors logged to Sentry.</done>
</task>

<task type="auto">
  <name>Task 2: Harden approve-signup and send-notification routes</name>
  <files>
    src/app/api/admin/approve-signup/route.ts
    src/app/api/admin/notifications/send/route.ts
  </files>
  <action>
**For src/app/api/admin/approve-signup/route.ts:**
- Import `{ validateRequestBody }` and `{ ApproveSignupSchema }` from `@/lib/api-validation`
- Import `* as Sentry` from `@sentry/nextjs`
- Replace the bare `const { signupId } = await request.json()` with:
  ```typescript
  const body = await request.json();
  const validation = validateRequestBody(body, ApproveSignupSchema, {
    userId: user.id,
    feature: "approve-signup",
  });
  if (!validation.success) return validation.response;
  const { signupId } = validation.data;
  ```
- Replace the silent `} catch {` block on the OneSignal notification (lines 97-99) with:
  ```typescript
  } catch (notifError) {
    Sentry.captureException(notifError, {
      level: "warning",
      tags: { feature: "notification" },
      extra: { coachId: user.id, newUserId: authData.user.id, action: "welcome-notification" },
    });
  }
  ```
  This addresses RELY-03 (no more silent catch).

**For src/app/api/admin/notifications/send/route.ts:**
- Import `{ validateRequestBody }` and `{ SendNotificationSchema }` from `@/lib/api-validation`
- Import `* as Sentry` from `@sentry/nextjs`
- Replace the manual `if (!title || !message)` and `if (!user_ids || !Array.isArray(user_ids)...)` checks with:
  ```typescript
  const body = await request.json();
  const validation = validateRequestBody(body, SendNotificationSchema, {
    userId: user.id,
    feature: "send-notification",
  });
  if (!validation.success) return validation.response;
  const { title, message, user_ids, send_to_all } = validation.data;
  ```
  The Zod schema's `.refine()` handles the "either send_to_all or user_ids required" logic.
- Replace `console.error("Error sending notification:", error)` with `Sentry.captureException(error, { tags: { feature: "send-notification" }, extra: { coachId: user.id, send_to_all } })`
  </action>
  <verify>
`pnpm tsc --noEmit 2>&1 | grep -c "error TS"` returns 0 new errors.
`grep -c "console.error" src/app/api/admin/approve-signup/route.ts src/app/api/admin/notifications/send/route.ts` returns 0.
`grep -c "catch {" src/app/api/admin/approve-signup/route.ts` returns 0 (no more silent catch).
  </verify>
  <done>Approve-signup validates signupId with Zod and logs notification failures to Sentry. Send-notification validates all fields with Zod (including the send_to_all/user_ids constraint) and logs errors to Sentry.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes (no new errors)
- Zero `console.error` in all 3 admin route files
- Zero silent `catch {}` blocks in all 3 admin route files
- OCR route uses OcrResultSchema to validate AI output before database save (ADMIN-02)
- All routes use validateRequestBody for input validation
</verification>

<success_criteria>
- ADMIN-02 satisfied: OCR extracted data validated with Zod before database storage
- RELY-03 partially satisfied: silent catch in approve-signup replaced with Sentry logging
- All 3 admin routes validate inputs with Zod
- All errors logged to Sentry with feature tags and context
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-hardening-api-routes/05-03-SUMMARY.md`
</output>
