---
phase: 09-admin-coach-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/[locale]/(admin)/admin/(panel)/settings/settings-form.tsx
  - src/app/[locale]/(admin)/admin/(panel)/layout.tsx
  - src/app/[locale]/(admin)/admin/(panel)/settings/error.tsx
  - src/app/[locale]/(admin)/admin/(panel)/signups/error.tsx
  - src/app/[locale]/(admin)/admin/(panel)/tickets/error.tsx
  - src/app/[locale]/(admin)/admin/(panel)/error.tsx
  - src/messages/en.json
  - src/messages/ar.json
autonomous: true

must_haves:
  truths:
    - "Admin settings form shows success toast on successful save"
    - "Admin settings form shows destructive toast on save failure"
    - "Admin settings form logs errors to Sentry with feature/operation tags"
    - "Admin settings form never silently swallows Supabase errors"
    - "Admin route rendering errors are caught by error.tsx boundaries"
    - "Admin error boundaries log to Sentry with admin-specific tags"
    - "Admin error boundaries show brutalist-styled error UI with retry button"
  artifacts:
    - path: "src/app/[locale]/(admin)/admin/(panel)/settings/settings-form.tsx"
      provides: "Settings form with try-catch, toast feedback, Sentry logging"
      contains: "Sentry.captureException"
    - path: "src/app/[locale]/(admin)/admin/(panel)/layout.tsx"
      provides: "Admin layout with Toaster component"
      contains: "Toaster"
    - path: "src/app/[locale]/(admin)/admin/(panel)/settings/error.tsx"
      provides: "Settings route error boundary"
      contains: "routeErrors.adminSettings"
    - path: "src/app/[locale]/(admin)/admin/(panel)/signups/error.tsx"
      provides: "Signups route error boundary"
      contains: "routeErrors.adminSignups"
    - path: "src/app/[locale]/(admin)/admin/(panel)/tickets/error.tsx"
      provides: "Tickets route error boundary"
      contains: "routeErrors.adminTickets"
    - path: "src/app/[locale]/(admin)/admin/(panel)/error.tsx"
      provides: "Panel-level fallback error boundary"
      contains: "routeErrors.adminPanel"
  key_links:
    - from: "src/app/[locale]/(admin)/admin/(panel)/settings/settings-form.tsx"
      to: "@sentry/nextjs"
      via: "captureException in catch block"
      pattern: "Sentry\\.captureException.*admin-settings"
    - from: "src/app/[locale]/(admin)/admin/(panel)/settings/settings-form.tsx"
      to: "@/hooks/use-toast"
      via: "toast() calls for success/error"
      pattern: "toast\\(.*variant.*destructive"
    - from: "src/app/[locale]/(admin)/admin/(panel)/layout.tsx"
      to: "@/components/ui/toaster"
      via: "Toaster rendered in admin layout"
      pattern: "<Toaster"
---

<objective>
Add error handling to admin settings form with toast feedback, add Toaster to admin layout, and create error.tsx boundaries for all admin routes.

Purpose: The admin settings form currently silently swallows Supabase errors -- the coach gets no feedback when saves fail. Admin routes have no error boundaries, meaning rendering errors crash the entire admin panel. This plan fixes both by adding try-catch with toast for async errors and error.tsx for rendering errors.

Output: Settings form with toast + Sentry, error.tsx for 4 admin routes, Toaster in admin layout.
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-coach-polish/09-RESEARCH.md
@src/app/[locale]/(admin)/admin/(panel)/settings/settings-form.tsx
@src/app/[locale]/(admin)/admin/(panel)/layout.tsx
@src/app/[locale]/(dashboard)/settings/error.tsx
@src/components/ui/toaster.tsx
@src/hooks/use-toast.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin settings form error handling + Toaster in layout</name>
  <files>
    src/app/[locale]/(admin)/admin/(panel)/settings/settings-form.tsx
    src/app/[locale]/(admin)/admin/(panel)/layout.tsx
    src/messages/en.json
    src/messages/ar.json
  </files>
  <action>
1. **settings-form.tsx** -- Wrap handleSave in try-catch with toast and Sentry:
   - Add imports: `import { toast } from "@/hooks/use-toast"` and `import * as Sentry from "@sentry/nextjs"`
   - Replace the `handleSave` function body with:
     ```typescript
     const handleSave = async () => {
       const supabase = createClient();

       try {
         const results = await Promise.all([
           supabase
             .from("system_config")
             .update({ value: checkInDays } as never)
             .eq("key", "check_in_frequency_days"),
           supabase
             .from("system_config")
             .update({
               value: JSON.stringify({ name: instapayName, number: instapayNumber }),
             } as never)
             .eq("key", "coach_instapay_account"),
           supabase
             .from("system_config")
             .update({
               value: JSON.stringify({
                 "3_months": Number(price3) || 0,
                 "6_months": Number(price6) || 0,
                 "12_months": Number(price12) || 0,
               }),
             } as never)
             .eq("key", "plan_pricing"),
         ]);

         // Check for Supabase errors in any update
         const errors = results.filter((r) => r.error);
         if (errors.length > 0) {
           throw new Error(
             `Failed to update ${errors.length} setting(s): ${errors.map((e) => e.error?.message).join(", ")}`
           );
         }

         // Success feedback
         toast({
           title: t("saveSuccess"),
           description: t("saveSuccessDescription"),
         });

         startTransition(() => router.refresh());
       } catch (error) {
         // Log to Sentry with admin context
         Sentry.captureException(error, {
           tags: {
             feature: "admin-settings",
             operation: "update-config",
             panel: "admin",
           },
           extra: {
             configKeys: ["check_in_frequency_days", "coach_instapay_account", "plan_pricing"],
           },
         });

         // Error feedback via toast
         toast({
           title: t("saveError"),
           description: error instanceof Error ? error.message : t("saveErrorGeneric"),
           variant: "destructive",
         });
       }
     };
     ```
   - Remove the `saved` state and `setTimeout` pattern (lines 17, 66-67) -- toast replaces this feedback mechanism
   - Update the save button text: Replace `{saved ? t("saved") : isPending ? t("saving") : t("save")}` with `{isPending ? t("saving") : t("save")}` (toast handles success feedback now)

2. **layout.tsx** -- Add Toaster component to admin layout:
   - Add import: `import { Toaster } from "@/components/ui/toaster"`
   - Add `<Toaster />` after `</AdminShell>` closing tag, as a sibling. Since the layout returns a single element, wrap in a fragment:
     ```tsx
     return (
       <>
         <AdminShell ...>{children}</AdminShell>
         <Toaster />
       </>
     );
     ```

3. **i18n keys** -- Add toast message keys under the existing `admin` namespace in both language files:
   - `en.json` > `admin`: Add:
     - `"saveSuccess": "Settings Saved"`
     - `"saveSuccessDescription": "Your configuration changes have been saved."`
     - `"saveError": "Save Failed"`
     - `"saveErrorGeneric": "An unexpected error occurred while saving settings."`
   - `ar.json` > `admin`: Add:
     - `"saveSuccess": "تم حفظ الإعدادات"`
     - `"saveSuccessDescription": "تم حفظ تغييرات التكوين الخاصة بك."`
     - `"saveError": "فشل الحفظ"`
     - `"saveErrorGeneric": "حدث خطأ غير متوقع أثناء حفظ الإعدادات."`
  </action>
  <verify>
    Run `pnpm tsc --noEmit` to verify no type errors. Grep for `Sentry.captureException` in settings-form.tsx. Grep for `Toaster` in admin layout. Grep for `saveSuccess` in both en.json and ar.json.
  </verify>
  <done>
    Admin settings form catches all Supabase errors, shows destructive toast on failure and default toast on success, logs errors to Sentry with admin-settings tags. Toaster component rendered in admin layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin route error boundaries + i18n</name>
  <files>
    src/app/[locale]/(admin)/admin/(panel)/settings/error.tsx
    src/app/[locale]/(admin)/admin/(panel)/signups/error.tsx
    src/app/[locale]/(admin)/admin/(panel)/tickets/error.tsx
    src/app/[locale]/(admin)/admin/(panel)/error.tsx
    src/messages/en.json
    src/messages/ar.json
  </files>
  <action>
1. **i18n keys** -- Add admin route error messages under `routeErrors` in both language files:
   - `en.json` > `routeErrors`: Add:
     - `"adminSettings": { "title": "SETTINGS ERROR", "description": "We couldn't load the admin settings. Please try again.", "retry": "TRY AGAIN" }`
     - `"adminSignups": { "title": "SIGNUPS ERROR", "description": "We couldn't load the signups page. Please try again.", "retry": "TRY AGAIN" }`
     - `"adminTickets": { "title": "TICKETS ERROR", "description": "We couldn't load the admin tickets. Please try again.", "retry": "TRY AGAIN" }`
     - `"adminPanel": { "title": "ADMIN ERROR", "description": "Something went wrong in the admin panel. Please try again.", "retry": "TRY AGAIN" }`
   - `ar.json` > `routeErrors`: Add:
     - `"adminSettings": { "title": "خطأ في الإعدادات", "description": "لم نتمكن من تحميل إعدادات المشرف. يرجى المحاولة مرة أخرى.", "retry": "حاول مرة أخرى" }`
     - `"adminSignups": { "title": "خطأ في التسجيلات", "description": "لم نتمكن من تحميل صفحة التسجيلات. يرجى المحاولة مرة أخرى.", "retry": "حاول مرة أخرى" }`
     - `"adminTickets": { "title": "خطأ في التذاكر", "description": "لم نتمكن من تحميل تذاكر المشرف. يرجى المحاولة مرة أخرى.", "retry": "حاول مرة أخرى" }`
     - `"adminPanel": { "title": "خطأ في لوحة المشرف", "description": "حدث خطأ في لوحة المشرف. يرجى المحاولة مرة أخرى.", "retry": "حاول مرة أخرى" }`

2. **Create 4 error.tsx files** -- Follow the EXACT pattern from `src/app/[locale]/(dashboard)/settings/error.tsx` (brutalist styling with Sentry logging). Each file follows the same template with different:
   - Function name
   - Translation namespace (under `routeErrors`)
   - Sentry tags (feature, route, panel: "admin")

   **Template for each:**
   ```tsx
   "use client";

   import * as Sentry from "@sentry/nextjs";
   import { useEffect } from "react";
   import { useTranslations } from "next-intl";
   import { AlertTriangle } from "lucide-react";

   export default function [Name]Error({
     error,
     reset,
   }: {
     error: Error & { digest?: string };
     reset: () => void;
   }) {
     const t = useTranslations("routeErrors.[namespace]");

     useEffect(() => {
       Sentry.captureException(error, {
         tags: {
           feature: "[feature-tag]",
           route: "[route-path]",
           panel: "admin",
         },
       });
     }, [error]);

     return (
       <div className="flex min-h-[60vh] items-center justify-center p-4">
         <div className="w-full max-w-md border-4 border-black bg-cream shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
           <div className="space-y-6 p-8">
             <div className="mx-auto flex h-20 w-20 items-center justify-center border-4 border-black bg-error-500">
               <AlertTriangle className="h-10 w-10 text-white" strokeWidth={3} />
             </div>
             <h1 className="text-center font-black text-2xl uppercase tracking-tight">
               {t("title")}
             </h1>
             <p className="text-center text-neutral-700 font-bold">
               {t("description")}
             </p>
             {error.digest && (
               <p className="text-center text-xs text-neutral-500 font-mono">
                 Error ID: {error.digest}
               </p>
             )}
             <button
               onClick={() => reset()}
               className="w-full border-4 border-black bg-primary py-3 font-black text-white uppercase tracking-wide shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"
             >
               {t("retry")}
             </button>
           </div>
         </div>
       </div>
     );
   }
   ```

   **Specific values for each file:**

   | File | Function Name | Namespace | Feature Tag | Route |
   |------|--------------|-----------|-------------|-------|
   | settings/error.tsx | AdminSettingsError | adminSettings | admin-settings-page | /admin/settings |
   | signups/error.tsx | AdminSignupsError | adminSignups | admin-signups-page | /admin/signups |
   | tickets/error.tsx | AdminTicketsError | adminTickets | admin-tickets-page | /admin/tickets |
   | (panel)/error.tsx | AdminPanelError | adminPanel | admin-panel | /admin |

   Note: The `bg-cream` class is used in the brutalist error template (same as dashboard). The admin panel uses `bg-stone-50` for its regular pages, but error boundaries use the brutalist card pattern which has `bg-cream` inside the card and the card sits on a flex-centered container that inherits the page background.
  </action>
  <verify>
    Run `pnpm tsc --noEmit` to verify no type errors. Verify all 4 error.tsx files exist: `ls src/app/[locale]/(admin)/admin/(panel)/error.tsx src/app/[locale]/(admin)/admin/(panel)/settings/error.tsx src/app/[locale]/(admin)/admin/(panel)/signups/error.tsx src/app/[locale]/(admin)/admin/(panel)/tickets/error.tsx`. Grep for `routeErrors.admin` in all error.tsx files. Grep for `adminSettings` in both en.json and ar.json.
  </verify>
  <done>
    Four admin route error boundaries created with brutalist styling, Sentry logging with admin-specific tags (panel: "admin"), and localized error messages in both English and Arabic. All follow the exact pattern established in Phase 8 dashboard error boundaries.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with no errors
2. `grep -r "Sentry.captureException" src/app/[locale]/(admin)/admin/(panel)/settings/settings-form.tsx` returns match
3. `grep -r "toast(" src/app/[locale]/(admin)/admin/(panel)/settings/settings-form.tsx` returns at least 2 matches (success + error)
4. `grep -r "Toaster" src/app/[locale]/(admin)/admin/(panel)/layout.tsx` returns match
5. All 4 error.tsx files exist in admin routes
6. Each error.tsx contains `Sentry.captureException` and `panel: "admin"` tag
7. `grep -r "adminSettings" src/messages/en.json src/messages/ar.json` returns matches in both
8. `grep -r "adminPanel" src/messages/en.json src/messages/ar.json` returns matches in both
9. No `Promise.all` without error checking in settings-form.tsx
</verification>

<success_criteria>
- Settings form shows success toast on save, destructive toast on failure
- Settings form logs all errors to Sentry with admin-settings feature tag
- No Supabase errors are silently swallowed (Promise.all results checked)
- Toaster component rendered in admin panel layout
- 4 admin route error boundaries with brutalist styling
- Error boundaries log to Sentry with panel: "admin" tag
- All error messages available in English and Arabic
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-coach-polish/09-02-SUMMARY.md`
</output>
