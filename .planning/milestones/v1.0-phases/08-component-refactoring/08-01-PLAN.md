---
phase: 08-component-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-check-in-lock.ts
  - src/app/[locale]/(dashboard)/check-in/_components/check-in-locked.tsx
  - src/app/[locale]/(dashboard)/check-in/_components/step-progress.tsx
  - src/app/[locale]/(dashboard)/check-in/_components/weight-step.tsx
  - src/app/[locale]/(dashboard)/check-in/_components/fitness-step.tsx
  - src/app/[locale]/(dashboard)/check-in/_components/dietary-step.tsx
  - src/app/[locale]/(dashboard)/check-in/_components/photos-step.tsx
  - src/app/[locale]/(dashboard)/check-in/_components/review-step.tsx
  - src/app/[locale]/(dashboard)/check-in/_components/step-navigation.tsx
  - src/app/[locale]/(dashboard)/check-in/page.tsx
autonomous: true

must_haves:
  truths:
    - "Check-in page renders identically before and after refactor"
    - "Multi-step form navigation works (next, back, submit)"
    - "Check-in lock status still loads and displays correctly"
    - "Photo upload, validation, and submission all function"
    - "check-in/page.tsx is under 400 lines"
  artifacts:
    - path: "src/hooks/use-check-in-lock.ts"
      provides: "Lock status checking extracted from check-in page"
      exports: ["useCheckInLock"]
    - path: "src/app/[locale]/(dashboard)/check-in/_components/weight-step.tsx"
      provides: "Step 1 form section (weight + measurements)"
    - path: "src/app/[locale]/(dashboard)/check-in/_components/fitness-step.tsx"
      provides: "Step 2 form section (performance + wellbeing metrics)"
    - path: "src/app/[locale]/(dashboard)/check-in/_components/dietary-step.tsx"
      provides: "Step 3 form section (dietary adherence + injuries)"
    - path: "src/app/[locale]/(dashboard)/check-in/_components/photos-step.tsx"
      provides: "Step 4 form section (photo upload)"
    - path: "src/app/[locale]/(dashboard)/check-in/_components/review-step.tsx"
      provides: "Step 5 form section (review + notes)"
    - path: "src/app/[locale]/(dashboard)/check-in/page.tsx"
      provides: "Orchestration-only page under 400 lines"
  key_links:
    - from: "src/app/[locale]/(dashboard)/check-in/page.tsx"
      to: "src/hooks/use-check-in-lock.ts"
      via: "useCheckInLock hook call"
      pattern: "useCheckInLock\\(user"
    - from: "_components/*.tsx"
      to: "react-hook-form"
      via: "useFormContext for form field access"
      pattern: "useFormContext"
---

<objective>
Split the 668-line check-in page into focused sub-components using FormProvider pattern and extract the lock-checking logic into a reusable hook.

Purpose: The check-in page is the largest component in the app (668 lines) with 5 distinct form steps, lock-checking logic, and photo upload handling. Splitting into _components/ with FormProvider makes each piece maintainable and testable.

Output: check-in/page.tsx reduced to orchestration-only (~150-200 lines), 7 sub-components in _components/, 1 new custom hook.
</objective>

<execution_context>
@/Users/ziadadel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ziadadel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-component-refactoring/08-RESEARCH.md
@src/app/[locale]/(dashboard)/check-in/page.tsx
@src/hooks/use-auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract useCheckInLock hook and create check-in sub-components</name>
  <files>
    src/hooks/use-check-in-lock.ts
    src/app/[locale]/(dashboard)/check-in/_components/check-in-locked.tsx
    src/app/[locale]/(dashboard)/check-in/_components/step-progress.tsx
    src/app/[locale]/(dashboard)/check-in/_components/weight-step.tsx
    src/app/[locale]/(dashboard)/check-in/_components/fitness-step.tsx
    src/app/[locale]/(dashboard)/check-in/_components/dietary-step.tsx
    src/app/[locale]/(dashboard)/check-in/_components/photos-step.tsx
    src/app/[locale]/(dashboard)/check-in/_components/review-step.tsx
    src/app/[locale]/(dashboard)/check-in/_components/step-navigation.tsx
  </files>
  <action>
    1. Create `src/hooks/use-check-in-lock.ts`:
       - Extract the entire useEffect block (lines 70-146 from current page) that checks lock status
       - Hook signature: `useCheckInLock(userId: string | undefined)`
       - Returns: `{ isLocked, nextCheckInDate, daysUntilNextCheckIn, isLoadingLockStatus }`
       - Include the Sentry import and error logging
       - Import createClient from @/lib/supabase/client

    2. Create `_components/check-in-locked.tsx`:
       - Extract the locked notice UI (lines 321-354 from current page)
       - Props: `{ nextCheckInDate: Date, daysUntilNextCheckIn: number }`
       - "use client" with useTranslations("checkIn")
       - Import Lock, Calendar from lucide-react

    3. Create `_components/step-progress.tsx`:
       - Extract the progress steps bar (lines 362-386)
       - Props: `{ currentStep: number, steps: Array<{ id: number; name: string; icon: LucideIcon }> }`
       - "use client" — purely presentational with step highlighting logic

    4. Create `_components/weight-step.tsx`:
       - Extract Step 1 form section (lines 391-434)
       - "use client" with `useFormContext<CheckInFormData>()` to access register/errors
       - Import useTranslations for "checkIn" and "units" namespaces
       - Export the CheckInFormData type and checkInSchema from a shared types location OR keep schema in page.tsx and import type via FormProvider generic

    5. Create `_components/fitness-step.tsx`:
       - Extract Step 2 form section (lines 437-487)
       - "use client" with useFormContext — uses register, watch, setValue
       - Rating button rows for energy and sleep (1-10 scale)

    6. Create `_components/dietary-step.tsx`:
       - Extract Step 3 form section (lines 490-537)
       - "use client" with useFormContext — dietary adherence rating + diet notes + injuries

    7. Create `_components/photos-step.tsx`:
       - Extract Step 4 form section (lines 540-580)
       - Props: `{ uploadedPhotos: File[], onPhotoChange: (e: ChangeEvent) => void, onRemovePhoto: (index: number) => void }`
       - Photo state stays in parent (needed for submission), but UI is in this component
       - "use client" with useTranslations("checkIn")

    8. Create `_components/review-step.tsx`:
       - Extract Step 5 review section (lines 583-618)
       - "use client" with useFormContext to watch field values
       - Props: `{ uploadedPhotosCount: number }` (for the photos count display)

    9. Create `_components/step-navigation.tsx`:
       - Extract navigation buttons (lines 622-662)
       - Props: `{ currentStep: number, totalSteps: number, isSubmitting: boolean, onBack: () => void, onNext: (e?: MouseEvent) => void }`
       - "use client" with useTranslations for "common" and "checkIn"

    IMPORTANT: Move the Zod schema (checkInSchema) and CheckInFormData type to the top of page.tsx and export them, so sub-components can import the type for useFormContext<CheckInFormData>. Alternatively, create a shared `_components/schema.ts` file for the schema and type.

    All sub-components must preserve existing Tailwind classes, touch targets (h-12), and i18n patterns exactly.
  </action>
  <verify>
    All new files exist:
    - `ls src/hooks/use-check-in-lock.ts`
    - `ls src/app/[locale]/(dashboard)/check-in/_components/*.tsx`
    Should show 8 files in _components/ plus the hook file.
  </verify>
  <done>All 9 sub-component/hook files created with correct props, useFormContext usage, and preserved styling</done>
</task>

<task type="auto">
  <name>Task 2: Refactor check-in page.tsx to use FormProvider and imported sub-components</name>
  <files>
    src/app/[locale]/(dashboard)/check-in/page.tsx
  </files>
  <action>
    Rewrite check-in/page.tsx as an orchestration component:

    1. Keep at top of file: "use client", imports, checkInSchema + CheckInFormData (or import from schema file)
    2. Import all sub-components from ./_components/
    3. Import useCheckInLock from @/hooks/use-check-in-lock
    4. Import FormProvider from react-hook-form

    The page should:
    - Call useCheckInLock(user?.id) for lock status
    - Call useForm<CheckInFormData> with zodResolver
    - Manage state: currentStep, isSubmitting, uploadedPhotos (these stay here)
    - Keep handler functions: handlePhotoChange, removePhoto, uploadPhotosToStorage, validateStep, handleNext, handleBack, onSubmit
    - Wrap form in <FormProvider {...methods}>
    - Render: submission overlay, header, CheckInLocked (conditional), StepProgress, form steps (conditional on currentStep), StepNavigation

    The page should NOT contain any form field JSX — all field rendering delegated to step components.

    Target: page.tsx should be approximately 150-250 lines (orchestration + handlers + FormProvider wrapper).

    After refactoring, run `pnpm tsc --noEmit` to verify no TypeScript errors.
    Then run `pnpm build` to verify the build succeeds.
  </action>
  <verify>
    `wc -l src/app/[locale]/(dashboard)/check-in/page.tsx` shows under 400 lines.
    `pnpm tsc --noEmit` passes with no errors.
    `pnpm build` succeeds.
  </verify>
  <done>check-in/page.tsx is under 400 lines, uses FormProvider, delegates all step UI to sub-components, TypeScript compiles clean, build succeeds</done>
</task>

</tasks>

<verification>
- `wc -l src/app/[locale]/(dashboard)/check-in/page.tsx` < 400
- `ls src/app/[locale]/(dashboard)/check-in/_components/` shows 8+ files
- `ls src/hooks/use-check-in-lock.ts` exists
- `pnpm tsc --noEmit` passes
- `pnpm build` succeeds
</verification>

<success_criteria>
- Check-in page reduced from 668 to under 400 lines
- All form steps extracted to _components/ using useFormContext
- Lock-checking logic extracted to reusable useCheckInLock hook
- No TypeScript errors, build succeeds
- Functionality preserved (form navigation, validation, photo upload, submission)
</success_criteria>

<output>
After completion, create `.planning/phases/08-component-refactoring/08-01-SUMMARY.md`
</output>
